@{
    Layout = null;

    var statusLegends = new Dictionary<string, string>
    {
        { "已檢驗", "#22c55e" },
        { "待檢驗", "#eab308" },
        { "應檢未檢", "#ef4444" },
        { "其他狀態", "#64748b" }
    };
}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機台巡檢紀錄</title>
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-size: clamp(14px, 1vw, 20px);
        }

        html, body {
            height: 100%;
            font-family: "Microsoft JhengHei", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        }

        p {
            margin: 0;
            padding: 2px 0;
        }

        ol, ul {
            margin: 0;
            padding-left: 1.25rem;
        }

        body {
            display: flex;
            flex-direction: column;
            background-color: #0f172a;
            color: white;
        }

        .content-wrapper {
            flex: 1;
            padding: 20px 5px;
            overflow: auto;
        }

        footer {
            text-align: center;
            font-size: small;
            padding: 10px;
            background: #1e293b;
            color: #94a3b8;
        }

        .custom-tooltip .tooltip-inner {
            overflow-y:auto;
            text-align: left;
            white-space: normal;
            width: fit-content; /* 改這行 */
            max-width: 500px; /* 加這行，設定最大寬度 */
            min-width: 300px;
            max-height:100vh;
            background-color: rgba(0, 0, 0, 0.9);
            color: #f8fafc;
            font-size: 13px;
            line-height: 1.6;
            padding: 10px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .custom-tooltip .tooltip-arrow::before {
            background-color: rgba(0, 0, 0, 0.9);
        }

        .query-form {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .query-form input[type="date"] {
                padding: 5px 10px;
                background-color: #334155;
                color: white;
                border: 1px solid #475569;
                border-radius: 4px;
            }

            .query-form button {
                padding: 6px 20px;
                background-color: #0071b2;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

                .query-form button:hover {
                    background-color: #005a8f;
                }

        .no-data-message {
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-top: 40px;
        }

            .no-data-message h4 {
                color: #94a3b8;
                margin-bottom: 10px;
            }

            .no-data-message p {
                color: #64748b;
            }
    </style>
</head>
<body>
    <main class="content-wrapper container-fluid">
        <div style="padding: 20px; display:fl.ex">
            <!-- 標題與查詢表單 -->

            <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content:space-between; gap: 20px;">
                <div style="display:flex; align-items:end; gap: 20px;">
                    <h3 style="margin: 0; white-space: nowrap;">機台巡檢紀錄</h3>
                    <div class="query-form">
                        <input type="date" id="dateInput" value="@ViewBag.SelectedDate">
                        <button type="button" onclick="loadData()">查詢</button>
                    </div>
                    <span style="color:floralwhite">* 點擊格子即可固定懸浮視窗</span>
                </div>
                <div style="padding: 15px; display: flex; align-items: center; justify-content: end; width: fit-content;">
                    <div>
                        @foreach (var legend in statusLegends)
                        {
                            <span style="margin-left: 30px;">
                                <span style="display: inline-block; width: 20px; height: 20px; background-color: @legend.Value; vertical-align: middle; margin-right: 5px; border: 1px solid black;"></span>
                                <span>@legend.Key</span>
                            </span>
                        }
                    </div>
                </div>
            </div>




            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger mb-3">
                    @TempData["ErrorMessage"]
                </div>
            }

            <!-- Loading -->
            <div id="loadingOverlay" style="width: 100%; height: 50vh; display: flex; align-items: center; justify-content: center;">
                <div style="font-size: 20px; color: #94a3b8;">載入中...</div>
            </div>

            <!-- Error -->
            <div id="errorOverlay" style="width: 100%; display: none;">
                <div class="no-data-message">
                    <h4>系統錯誤</h4>
                    <div id="errorMessage" class="text-danger mb-3" style="font-size: 18px;"></div>
                    <button class="btn btn-primary" onclick="loadData()">重新載入</button>
                </div>
            </div>

            <!-- No Data -->
            <div id="noDataOverlay" style="width: 100%; display: none;">
                <div class="no-data-message">
                    <h4>該日期無巡檢記錄</h4>
                    <p>請選擇其他日期查詢</p>
                </div>
            </div>

            <!-- Main Content -->
            <div id="mainContent" style="display: none;">
                <!-- Timeline Table -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #475569;">
                        <thead>
                            <tr style="background-color: #1e293b;">
                                <th style="border: 1px solid #475569; padding: 0; height: 40px; width: 150px; text-align: center;">機台</th>
                                <th style="border: 1px solid #475569; padding: 0; position: relative;">
                                    <div id="hourHeaders" style="display: flex; height: 40px;"></div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="timelineBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer>
        Copyright © 2025 Gudeng Industrial Corp. All Rights Reserved.
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        var statusColors = {
            '已檢驗': '#22c55e',
            '待檢驗': '#eab308',
            '應檢未檢': '#ef4444',
            '停機': '#64748b',
            '調機': '#64748b',
            '不用檢驗': '#64748b',
            'RUN < 60 min': '#64748b',
            'RUN < 60': '#64748b',
            '非排班時間': '#64748b',
            '沒有排班': '#64748b',
            '機台無工單': '#64748b'
        };

        // 狀態優先級
        var statusPriority = {
            '應檢未檢': 1,
            '不用檢驗': 2,
            '機台無工單': 2,
            'RUN < 60 min': 2,
            'RUN < 60': 2,
            '非排班時間': 2,
            '調機': 2,
            '停機': 2,
            '沒有排班': 3,
            '待檢驗': 4,
            '已檢驗': 5
        };

        // 小時到格子的映射
        var hourToGrid = {
            0: 0, 1: 1, 2: 2, 3: 3, 4: 4,
            5: 5, 6: 5, 7: 5,
            8: 6, 9: 7, 10: 8, 11: 9, 12: 10, 13: 11, 14: 12, 15: 13, 16: 14,
            17: 15, 18: 15, 19: 15,
            20: 16, 21: 17, 22: 18, 23: 19
        };

        function calculatePosition(startHour, endHour) {
            var startGrid = hourToGrid[startHour];
            var endHour24 = endHour === 24 ? 24 : endHour;
            var lastHour = endHour24 - 1;
            var endGrid = (hourToGrid[lastHour] || 19) + 1;

            var leftPos = startGrid * 5;
            var width = (endGrid - startGrid) * 5;

            return { left: leftPos, width: width };
        }


        var machineData = {};
        var selectedDate = '@ViewBag.SelectedDate';
        console.log("selectedDate",selectedDate)
        // 狀態顏色映射

        $(document).ready(function () {
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');
            console.log("dateParam",dateParam)
            if (dateParam) {
                selectedDate = dateParam;
            } else {
                selectedDate = '@ViewBag.SelectedDate';
                const newUrl = window.location.pathname + '?date=' + selectedDate;
                window.history.replaceState(null, '', newUrl);
            }
            console.log("selectedDateB",selectedDate)
            $('#dateInput').val(selectedDate);
            loadData();

            setInterval(function() {
                loadData();
            }, 15 * 60 * 1000);
        });


        function loadData() {
            selectedDate = $('#dateInput').val();

            const newUrl = window.location.pathname + '?date=' + selectedDate;
            window.history.replaceState(null, '', newUrl);
            $('#loadingOverlay').show();
            $('#errorOverlay').hide();
            $('#noDataOverlay').hide();
            $('#mainContent').hide();
            $('#legendSection').hide();

            $.ajax({
                url: '@Url.Action("GetInspectionData", "ActivityChart")',
                type: 'GET',
                data: { date: selectedDate },
                success: function (result) {
                    if (result.success) {
                        console.log('獲取到 ' + result.count + ' 筆資料');

                        if (!result.data || result.data.length === 0) {
                            showNoData();
                            return;
                        }

                        machineData = transformData(result.data);
                        renderTimeline();
                        $('#loadingOverlay').hide();
                        $('#legendSection').show();
                        $('#mainContent').show();
                    } else {
                        showError(result.error || '獲取資料失敗');
                    }
                },
                error: function (xhr, status, error) {
                    showError('無法連接到伺服器: ' + error);
                }
            });
        }

        function showError(message) {
            $('#errorMessage').text(message);
            $('#loadingOverlay').hide();
            $('#errorOverlay').show();
        }

        function showNoData() {
            $('#loadingOverlay').hide();
            $('#noDataOverlay').show();
        }

        function transformData(rawData) {
            var grouped = {};

            rawData.forEach(function (row) {
                var deviceId = row.deviceId;
                if (!deviceId) return;

                if (!grouped[deviceId]) {
                    grouped[deviceId] = {
                        deviceId: deviceId,
                        deviceName: row.deviceName || deviceId,
                        area: row.area || '',
                        slots: []
                    };
                }

                var timeRange = row.scheduleRange || '';
                var startHour = 0, endHour = 0;

                if (timeRange && timeRange.includes(':')) {
                    var parts = timeRange.split('-');
                    if (parts.length === 2) {
                        startHour = parseInt(parts[0].split(':')[0], 10);
                        endHour = parseInt(parts[1].split(':')[0], 10);
                    }
                }

                var finalStatus = '不用檢驗';
                var maxPriority = 0;

                if (row.inspections && row.inspections.length > 0) {
                    row.inspections.forEach(function(insp) {
                        var currentStatus = insp.status || '不用檢驗';
                        var currentPriority = statusPriority[currentStatus] || 0;
                        if (currentPriority > maxPriority) {
                            maxPriority = currentPriority;
                            finalStatus = currentStatus;
                        }
                    });
                }

                var totalRunTime = 0;
                if (row.inspections && row.inspections.length > 0) {
                    row.inspections.forEach(function(insp) {
                        totalRunTime += parseFloat(insp.runTime) || 0;
                    });
                }

                grouped[deviceId].slots.push({
                    timeRange: timeRange,
                    startHour: startHour,
                    endHour: endHour,
                    status: finalStatus,
                    inspections: row.inspections || [],
                    runTime: totalRunTime
                });
            });

            return grouped;
        }

        function buildTooltipContent(displayName, deviceId, cellData) {
            var html = '<div>';
            html += '<div><strong>機台：</strong>' + displayName + '</div>';
            html += '<div><strong>ID：</strong>' + deviceId + '</div>';

            if (cellData.runTime > 0) {
                html += '<div><strong>總運作工時：</strong>' + cellData.runTime.toFixed(1) + ' min</div>';
            }

            if (cellData.inspections && cellData.inspections.length > 0) {
                html += '<div style="margin-top: 8px; margin-bottom: 4px;"><strong>檢驗記錄：</strong></div>';

                cellData.inspections.forEach(function(insp, idx) {
                    var statusColor = (statusColors[insp.status] || '#64748b');

                    if (idx > 0) {
                        html += '<hr style="margin: 8px 0; border: none; border-top: 1px solid rgba(255,255,255,0.2);">';
                    }

                    html += '<div style="margin-left: 8px; margin-top: 6px; padding: 8px; background-color: rgba(255,255,255,0.05); border-radius: 4px; border-left: 3px solid ' + statusColor + ';">';
                    html += '<div style="margin-bottom: 4px;"><strong style="font-size: 13px;">' + (idx + 1) + '. ' + (insp.status || '') + '</strong></div>';

                    var startTime = insp.inspectStartTime ? formatTime(insp.inspectStartTime) : '';
                    var endTime = insp.inspectEndTime ? formatTime(insp.inspectEndTime) : '';

                    if (startTime || endTime) {
                        html += '<div style="font-size: 11px; color: #cbd5e1; margin-bottom: 2px;">時間: ' +
                            (startTime || '-') + ' ~ ' + (endTime || '-') + '</div>';
                    }

                    if (insp.inspectUserName) {
                        html += '<div style="font-size: 11px; color: #cbd5e1; margin-bottom: 2px;">檢驗人: ' + insp.inspectUserName + '</div>';
                    }

                    if (insp.workOrderNo) {
                        html += '<div style="font-size: 11px; color: #cbd5e1; margin-bottom: 2px;">工單: ' + insp.workOrderNo + '</div>';
                        html += '<div style="font-size: 11px; color: #cbd5e1; margin-bottom: 2px;">料號: ' + insp.prodNo + '</div>';
                        html += '<div style="font-size: 11px; color: #cbd5e1; margin-bottom: 2px;">料號: ' + insp.prodDesc + '</div>';
                    }

                    if (insp.responseUserNames) {
                        html += '<div style="font-size: 11px; color: #cbd5e1; margin-bottom: 2px;">排班人員: ' + insp.responseUserNames + '</div>';
                    }

                    if (insp.runTime && parseFloat(insp.runTime) >= 0) {
                        html += '<div style="font-size: 11px; color: #cbd5e1; margin-bottom: 2px;">RunTime 時間: ' + insp.runTime + ' min</div>';
                    }

                    if (insp.status) {
                        html += '<div style="font-size: 11px; margin-top: 4px; padding-top: 4px; border-top: 1px solid rgba(255,255,255,0.1);">' +
                            '<span style="display: inline-block; width: 10px; height: 10px; background-color: ' + statusColor + '; border-radius: 50%; margin-right: 6px; vertical-align: middle;"></span>' +
                            '<strong>狀態: ' + insp.status + '</strong></div>';
                    }

                    html += '</div>';
                });
            } else {
                html += '<div style="margin-top: 8px; color: #94a3b8;">無檢驗記錄</div>';
            }

            html += '</div>';
            return html;
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            var d = new Date(dateStr);
            var h = ('0' + d.getHours()).slice(-2);
            var m = ('0' + d.getMinutes()).slice(-2);
            return h + ':' + m;
        }

        function renderTimeline() {
            var $hourHeaders = $('#hourHeaders');
            $hourHeaders.empty();

            var hours = [0, 1, 2, 3, 4, '5-7', 8, 9, 10, 11, 12, 13, 14, 15, 16, '17-19', 20, 21, 22, 23];

            hours.forEach(function(hour) {
                $hourHeaders.append(
                    $('<div>')
                        .css({
                            'flex': '0 0 5%',
                            'display': 'flex',
                            'align-items': 'center',
                            'justify-content': 'center',
                            'height': '40px',
                            'background-color': '#1e293b',
                            'border-right': '1px solid #475569',
                            'font-size': '11px',
                            'color': 'white'
                        })
                        .text(hour)
                );
            });

            var $timelineBody = $('#timelineBody').empty();

            Object.keys(machineData).forEach(function (deviceId) {
                var machineInfo = machineData[deviceId];
                var displayName = machineInfo.deviceName || deviceId;
                var slots = machineInfo.slots || [];

                var $tr = $('<tr>').css('height', '40px');

                var $machineTd = $('<td>')
                    .css({
                        'border': '1px solid #475569',
                        'padding': '10px',
                        'vertical-align': 'middle',
                        'background-color': '#166534',
                        'text-align': 'left',           
                        'height': '40px',
                        'line-height': '1.2',
                        'white-space': 'nowrap'
                    })
                    .text(displayName);

                var $timelineTd = $('<td>')
                    .css({
                        'border': '1px solid #475569',
                        'padding': '0',
                        'position': 'relative',
                        'height': '40px'
                    });

                var $timelineContainer = $('<div>')
                    .css({
                        'position': 'relative',
                        'height': '40px',
                        'width': '100%'
                    });

                slots.forEach(function (cellData) {
                    if (!cellData.timeRange || cellData.status === '非排班時間') {
                        return;
                    }

                    var position = calculatePosition(cellData.startHour, cellData.endHour);
                    var bgColor = statusColors[cellData.status] || '#64748b';

                    // 這邊是時間軸 x 機台的每個小區塊
                    var $cell = $('<div>')
                        .css({
                            'position': 'absolute',
                            'left': position.left + '%',
                            'width': position.width + '%',
                            'top': '0',
                            'height': '40px',
                            'border-right': '1px solid black',
                            'cursor': 'pointer',
                            'transition': 'all 0.3s',
                            'font-size': 'clamp(12px,0.8vw, 18px)',
                            'background-color': bgColor,
                            'display': 'flex',
                            'flex-direction': 'column',
                            'align-items': 'center',
                            'justify-content': 'center',
                            'overflow': 'hidden',
                            'padding': '2px'
                        })
                        .attr('data-bs-toggle', 'tooltip')
                        .attr('data-bs-html', 'true')
                        .attr('data-bs-placement', 'auto')
                        .attr('data-bs-title', buildTooltipContent(displayName, deviceId, cellData))
                        .hover(
                            function () { $(this).css('filter', 'brightness(1.2)'); },
                            function () { $(this).css('filter', 'brightness(1)'); }
                        );

                    if (cellData.inspections && cellData.inspections.length > 0) {
                        var actualInspections = cellData.inspections.filter(function(insp) {
                            return insp.inspectType && insp.inspectType.trim() !== '';
                        });

                        if (actualInspections.length > 0) {
                            actualInspections.slice(0, 2).forEach(function(insp) {
                                var startTime = formatTime(insp.inspectStartTime);
                                var endTime = formatTime(insp.inspectEndTime);
                                var timeText = (startTime && endTime) ? (startTime + '~' + endTime) : '';
                                var displayText = timeText ? (timeText + ' ' + (insp.inspectType || '')) : (insp.inspectType || '');

                                $cell.append(
                                    $('<div>').css({
                                        'color': 'white',
                                        'font-size': 'clamp(10px, 0.8vw, 18px)',
                                        'line-height': '1.2',
                                        'width': '100%',
                                        'text-align': 'center',
                                        'white-space': 'nowrap',
                                        'overflow': 'hidden',
                                        'text-overflow': 'ellipsis'
                                    }).text(displayText)
                                );
                            });
                        } else {
                            $cell.append(
                                $('<div>')
                                    .css({
                                        'color': 'white',
                                         'white-space': 'nowrap',
                                        'font-size': 'clamp(12px, 0.8vw, 18px)',
                                        'line-height': '1.2'
                                    })
                                    .text(formatStatusText(cellData.status) || '不用檢驗')
                            );

                            if (cellData.status === '應檢未檢' && cellData.inspections.length > 0) {
                                var uniqueWorkOrders = cellData.inspections
                                    .map(function(insp) { return insp.workOrderNo; })
                                    .filter(function(wo, idx, arr) { return wo && arr.indexOf(wo) === idx; });

                                if (uniqueWorkOrders.length > 0) {
                                    var displayWorkOrders = uniqueWorkOrders.length < 3
                                        ? uniqueWorkOrders
                                        : uniqueWorkOrders.slice(0, 2).concat(['...']);

                                    var $workOrderContainer = $('<div>').css({
                                        'color': '#ffffff',
                                        'font-size': 'clamp(12px, 0.8vw, 18px)',
                                        'line-height': '1.2',
                                        'margin-top': '2px',
                                        'font-weight': 'bold',
                                        'text-align': 'center'
                                    });

                                    displayWorkOrders.forEach(function(wo) {
                                        $workOrderContainer.append(
                                            $('<div>').css({
                                                'color': '#ffffff',
                                                'font-size': 'clamp(12px, 0.8vw, 18px)',
                                                'line-height': '1.1',
                                                'margin-top': '1px',
                                                'font-weight': 'bold',
                                                'text-align': 'center'
                                            }).text(wo === '...' ? '...' : wo)
                                        );
                                    });

                                    $cell.append($workOrderContainer);
                                }
                            } else if (cellData.inspections.length === 1) {
                                var firstInsp = cellData.inspections[0];
                                if (firstInsp.workOrderNo) {
                                    $cell.append(
                                        $('<div>').css({
                                            'color': '#ffffff',
                                            'font-size': 'clamp(12px,0.8vw, 18px)',
                                            'line-height': '1.2',
                                            'margin-top': '2px',
                                            'font-weight': 'bold'
                                        }).text(firstInsp.workOrderNo)
                                    );
                                }
                            }
                        }
                    } else {
                        $cell.append(
                            $('<div>')
                                .css({
                                    'color': 'white',
                                    'font-size': 'clamp(12px,0.8vw, 18px)',
                                    'line-height': '1.2'
                                })
                                .text(formatStatusText(cellData.status) || '不用檢驗')
                        );
                    }

                    $timelineContainer.append($cell);
                });

                $timelineTd.append($timelineContainer);
                $tr.append($machineTd).append($timelineTd);
                $timelineBody.append($tr);
            });

            // 初始化 Bootstrap Tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipMap = new Map();

            tooltipTriggerList.forEach(function (el) {
                const tooltip = new bootstrap.Tooltip(el, {
                    trigger: 'manual',
                    boundary: 'window',
                    container: 'body',
                    html: true,
                    template: '<div class="tooltip custom-tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner text-start"></div></div>'
                });
                tooltipMap.set(el, tooltip);

                let hoverTimeout = null;

                // Hover 功能
                el.addEventListener('mouseenter', function () {
                    if (!el.classList.contains('tooltip-locked')) {
                        hoverTimeout = setTimeout(() => tooltip.show(), 100);
                    }
                });

                el.addEventListener('mouseleave', function () {
                    clearTimeout(hoverTimeout);
                    if (!el.classList.contains('tooltip-locked')) {
                        tooltip.hide();
                    }
                });

                // Click 鎖定開關
                el.addEventListener('click', function (e) {
                    e.stopPropagation();

                    tooltipMap.forEach((t, elem) => {
                        if (elem !== el) {
                            t.hide();
                            elem.classList.remove('tooltip-locked');
                        }
                    });

                    if (el.classList.contains('tooltip-locked')) {
                        el.classList.remove('tooltip-locked');
                        tooltip.hide();
                    } else {
                        el.classList.add('tooltip-locked');
                        tooltip.show();
                    }
                });
            });

            // 點擊背景關閉所有 tooltip
            document.addEventListener('click', function () {
                tooltipMap.forEach((t, elem) => {
                    t.hide();
                    elem.classList.remove('tooltip-locked');
                });
            });
        }

        function formatStatusText(status) {
            if (status === 'RUN < 60') {
                return 'Run < 60 min';
            }
            return status;
        }



    </script>
</body>
</html>