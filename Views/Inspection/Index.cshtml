@model PatrolInspect.Models.LoginViewModel

@{
    ViewData["Title"] = "巡檢系統";
    Layout = "_Layout";
}

@section css {

}

<div class="container">
    <!-- Toast 容器 (用於 NFC 狀態提示) -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="nfcToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- 使用者資訊 -->
    <div class="border rounded p-2 mb-2 bg-light d-flex justify-content-between position-relative">
        <div>
            <strong>@ViewBag.UserName (@ViewBag.UserNo)</strong>
            <div style="color: #666;" onclick="showNFCTestModal('@ViewBag.UserNo')">@ViewBag.DepartmentName - @ViewBag.TitleName</div>
            <div class="fw-bold" style="font-size:12px; color: #666;" id="currentTime">@ViewBag.CurrentTime</div>
            <div class="text-secondary"></div>
        </div>
        <div class="position-absolute" style="top:5px; right:5px">
            <button class="btn btn-sm btn-light border" onclick="loadTodayInspection()">刷新資料</button>
        </div>

    </div>
    <div class="mb-2 w-100" style="padding:8px; color:black; border:1px solid black" onclick="showMachineIdInputModal()">
        <p>1. 請直接刷感應卡，如沒反應請下滾到最下面，先按"停止感應"後再選擇"啟動感應"</p>
        <p>2. 如有遇到問題請洽63030照錡，請紀錄工作跟時間以便於補資料</p>
    </div>
    <div class="d-flex gap-2" >
            <button class="btn btn-outline-secondary mb-2 w-100" style="padding:2px; color:black;" onclick="handleAction('會議')">會議</button >
            <button class="btn btn-outline-secondary mb-2 w-100" style="padding:2px; color:black;" onclick="handleAction('支援')">支援</button >
            <button class="btn btn-outline-secondary mb-2 w-100" style="padding:2px; color:black;" onclick="handleAction('文書處理')">文書作業</button >
    </div>

    <!-- 統計資訊 -->
    <div class="border rounded mb-2 bg-white">
        <div class="p-2">
            <div class="d-flex flex-wrap gap-2">
                <div class="d-flex gap-2 align-items-center">
                    <div class="rounded-circle" style="height:20px; width:20px; background: #d3ffd3;"></div>
                    <span style="font-size:12px">機台 RUN</span>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <div class="rounded-circle" style="height:20px; width:20px; background: #fffbce;"></div>
                    <span style="font-size:12px">機台 IDLE</span>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <div class="rounded-circle" style="height:20px; width:20px; background: #e4e4e4;"></div>
                    <span style="font-size:12px">機台 OFF</span>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <div class="rounded-circle" style="height:20px; width:20px; background: #eedadb;"></div>
                    <span style="font-size:12px">機台 ALARM</span>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <div class="rounded-circle" style="height:20px; width:20px; background: #f7cbac;"></div>
                    <span style="font-size:12px">距上次檢測超過2小時</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入 Spinner (Bootstrap) -->
    <div id="loading" class="text-center my-3 d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">載入中...</span>
        </div>
    </div>

    <!-- 錯誤訊息 Alert (Bootstrap) -->
    <div id="errorAlert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
        <span id="errorMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- 時段排程 Accordion -->
    <div id="timePeriodsSection" class="border rounded mb-2 bg-white">
        <h3 class="bg-light border-bottom p-2 m-0 fw-bold" style="font-size:16px">今日排程</h3>
        <div class="p-2">
            <div id="timePeriods" class="mb-2"></div>
        </div>
    </div>

    <!-- NFC 感應 -->
    <div class="border rounded mb-2 bg-white">
        <h3 class="bg-light border-bottom p-2 m-0 fw-bold" style="font-size:16px">NFC 感應</h3>
        <div class="p-2">
            <div class="mb-2">
                <button class="btn btn-sm btn-light border me-1 mb-1" onclick="manualStartNFC()">啟動感應</button>
                <button class="btn btn-sm btn-light border me-1 mb-1" onclick="stopNFC()">停止感應</button>
                如感應不到,請 1. 刷新頁面。 2. 按停止感應後再按啟動感應。
            </div>
        </div>
    </div>

    <!-- 檢驗開始提示 Modal -->
    <div id="inspectionModal" class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center" 
         style="background: rgba(0, 0, 0, 0.5); z-index: 9999;" onclick="closeInspectionModal(event)">
        <div class="bg-white p-4 border rounded text-center" style="max-width: 300px; width: 90%; border: 2px solid #333 !important;" onclick="event.stopPropagation()">
            <h3>檢驗開始</h3>
            <p><strong id="modalDevice">-</strong></p>
            <p id="modalTime">-</p>
            <p>巡檢請在機邊電腦完成資料上傳，其他非使用射出檢驗系統的檢驗，請點選檢驗時間明細送出檢驗數量</p>
            <button class="btn btn-dark" onclick="closeInspectionModal()">確定</button>
        </div>
    </div>

    <!-- 機邊檢驗 檢驗數量輸入Modal -->
    <div id="quantityInputModal" class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center"
         style="background: rgba(0,0,0,0.5); z-index: 1002;">
        <div class="bg-white p-4 rounded shadow" style="max-width: 450px; width: 90%;">
            <h3 id="quantityModalTitle" class="mb-3 text-center" style="color: #333;">輸入檢驗數量</h3>

            <div id="quantityModalInfo" class="bg-light p-3 rounded mb-3" 
                 style="border-left: 4px solid #0071b2; font-size: 14px; line-height: 1.5;">
                <!-- 動態填入檢驗資訊 -->
            </div>

            <form onsubmit="event.preventDefault(); submitInspectionQuantity();">
                <div class="d-flex flex-column gap-3 mb-3">
                    <div class="flex-fill">
                        <label for="quantityWoInput" class="form-label fw-semibold" style="color: #333;">如無工單資訊請輸入工單</label>
                        <input type="text" id="quantityWoInput" class="form-control text-center" placeholder="">
                    </div>
                    <div class="d-flex gap-2">
                        <div class="flex-fill">
                            <label for="okQuantity" class="form-label fw-semibold" style="color: #333;">OK數量</label>
                            <input type="number" id="okQuantity" min="0" max="9999" class="form-control text-center" placeholder="">
                        </div>
                        <div class="flex-fill">
                            <label for="ngQuantity" class="form-label fw-semibold" style="color: #333;">NG數量</label>
                            <input type="number" id="ngQuantity" min="0" max="9999" class="form-control text-center" placeholder="">
                        </div>
                    </div>
                    <div>
                        <label for="quantityRemark" class="form-label fw-semibold" style="color: #333;">備註</label>
                        <textarea rows="1" id="quantityRemark" maxlength="190" class="form-control" placeholder=""></textarea>
                    </div>
                </div>

                <div class="text-end">
                    <button type="button" onclick="closeQuantityInputModal()" class="btn btn-secondary me-2">取消</button>
                    <button type="submit" class="btn btn-primary" style="background: #0071b2;">確定提交</button>
                </div>
            </form>

            <input type="hidden" id="quantityRecordId" value="">
        </div>
    </div>



    <!-- NFC測試Modal -->
    @* <div id="nfcTestModal" class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center" 
         style="background: rgba(0,0,0,0.5); z-index: 1000;">
        <div class="bg-white p-4 rounded" style="max-width: 500px; width: 90%; max-height: 80%; overflow-y: auto;">
            <h3 class="mb-3" style="color: #333;">選擇測試 NFC 卡片</h3>

            <div class="mb-3">
                <input type="text" id="nfcSearchInput" placeholder="搜尋區域或卡片..." class="form-control" onkeyup="filterNFCCards()">
            </div>

            <div id="nfcCardList" class="border rounded" style="max-height: 300px; overflow-y: auto;">
                <!-- 動態生成的卡片列表 -->
            </div>

            <div class="text-end mt-3">
                <button onclick="closeNFCTestModal()" class="btn btn-secondary me-2">取消</button>
                <button onclick="testCustomNFC()" class="btn btn-primary">自訂卡片ID</button>
            </div>
        </div>
    </div> *@

    <!-- 自訂 NFC ID Modal -->
    @* <div id="customNFCModal" class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center" 
         style="background: rgba(0,0,0,0.5); z-index: 1001;">
        <div class="bg-white p-4 rounded" style="max-width: 400px; width: 90%;">
            <h3 class="mb-3" style="color: #333;">輸入自訂 NFC ID</h3>

            <input type="text" id="customNFCInput" placeholder="輸入 NFC 卡片 ID..." class="form-control mb-3">

            <div class="text-end">
                <button onclick="closeCustomNFCModal()" class="btn btn-secondary me-2">取消</button>
                <button onclick="executeCustomNFC()" class="btn btn-success">測試</button>
            </div>
        </div>
    </div> *@

    <!-- 機台ID輸入Modal -->
    <div id="machineIdInputModal" class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center" 
         style="background: rgba(0,0,0,0.5); z-index: 1001;">
        <div class="bg-white p-4 rounded" style="max-width: 400px; width: 90%;">
            <h3 class="mb-3" style="color: #333;"></h3>

            <input type="text" id="machineIdInput" placeholder="請掃描機台ID" class="form-control mb-3">

            <div class="text-end">
                <button onclick="closeMachineIdInputModal()" class="btn btn-secondary me-2">取消</button>
                <button onclick="executeMachineId()" id="executeMachineBtn" class="btn btn-success">確認</button>
            </div>
        </div>
    </div>

    <!-- 檢驗類型選擇Modal -->
    <div id="inspectTypeModal" class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center" 
         style="background: rgba(0,0,0,0.5); z-index: 1001;">
        <div class="bg-white p-4 rounded d-flex flex-column gap-2" style="max-width: 400px; width: 90%;">
            <div>
                <label class="form-label">請選擇檢驗項目</label>
            </div>
            <select id="inspectTypeOptions" onchange="handleInspectTypeChange()" class="form-select">
                <option value="">請選擇...</option>
            </select>
            <div class="text-end">
                <button onclick="closeInspectTypeModal()" class="btn btn-secondary me-2">取消</button>
                <button onclick="confirmInspectType()" class="btn btn-success">確認</button>
            </div>
        </div>
    </div>

    <!-- 入庫多工單輸入Modal -->
    <div id="warehouseOrderModal" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
         style="background: rgba(0,0,0,0.5); z-index: 1003;">
        <div class="d-flex align-items-center justify-content-center w-100 h-100 p-2">
            <div class="bg-white rounded shadow d-flex flex-column" 
                 style="max-width: 600px; width: 100%; max-height: 90vh; padding:10px;">
                
                <!-- 固定標題區域 -->
                <div class="d-flex flex-column p-1 border-bottom">
                    <h3 id="warehouseModalTitle" class="p-1 text-center" style="color: #333;">入庫檢驗</h3>
                    <div id="warehouseModalInfo" class="bg-light p-1 rounded mb-1" 
                         style="border-left: 4px solid #0071b2; font-size: 14px; line-height: 1.5;">
                        <!-- 動態填入檢驗資訊 -->
                    </div>
                </div>

                <!-- 可滾動內容區域 -->
                <div class="flex-fill p-2" style="overflow-y: auto;">
                    
                    <!-- 新增工單區域 -->
                    <div class="border rounded p-3 mb-3" style="background: #fafafa;">
                        <h5 class="mb-3" style="color: #333;">新增工單</h5>
                        
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex gap-2">
                                <div>
                                    <label for="newWorkOrder" class="form-label fw-semibold" style="color: #333; font-size: 13px;">
                                        工單號碼 *
                                    </label>
                                    <input type="text" id="newWorkOrder" placeholder="請輸入工單號碼" class="form-control">
                                </div>
                                <div>
                                    <label for="newOkQuantity" class="form-label fw-semibold" style="color: #333; font-size: 13px;">
                                        OK數量
                                    </label>
                                    <input type="number" id="newOkQuantity" min="0" max="9999" class="form-control text-center">
                                </div>
                                <div>
                                    <label for="newNgQuantity" class="form-label fw-semibold" style="color: #333; font-size: 13px;">
                                        NG數量
                                    </label>
                                    <input type="number" id="newNgQuantity" min="0" max="9999" class="form-control text-center">
                                </div>
                            </div>
                            
                            <label for="warehouseRemark" class="form-label fw-semibold" style="color: #333; font-size:13px">備註</label>
                            <div class="d-flex w-100 gap-1">
                                <textarea rows="1" id="warehouseRemark" maxlength="190" class="form-control" placeholder=""></textarea>
                                <button type="button" onclick="addWarehouseOrder()" class="btn btn-success" style="white-space: nowrap; font-size: 14px;">
                                    新增
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 工單清單區域 -->
                    <div class="mb-3">
                        <h5 class="mb-3" style="color: #333;">已新增的工單</h5>
                        <div id="warehouseOrderList" class="border rounded bg-white" style="max-height: 250px; overflow-y: auto;">
                            <div class="text-center text-muted p-4">尚未新增任何工單</div>
                        </div>
                    </div>
                </div>

                <!-- 固定按鈕區域 -->
                <div class="p-2 border-top" style="background: #fafafa;">
                    <div class="text-end">
                        <button type="button" onclick="closeWarehouseOrderModal()" class="btn btn-secondary me-2">取消</button>
                        <button type="button" onclick="submitWarehouseOrders()" class="btn btn-primary" style="background: #0071b2;">
                            提交檢驗
                        </button>
                    </div>
                </div>

                <input type="hidden" id="warehouseRecordId" value="">
            </div>
        </div>
    </div>
</div>

<div id="remarkModal" class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center"
     style="background: rgba(0,0,0,0.5); z-index: 1002;">
    <div class="bg-white p-4 rounded shadow" style="max-width: 450px; width: 90%;">
        <h3 id="remarkModalTitle" class="mb-3 text-center" style="color: #333;">備註</h3>

        <div id="remarkModalInfo" class="bg-light p-3 rounded mb-3"
             style="border-left: 4px solid #0071b2; font-size: 14px; line-height: 1.5;">
            <!-- 動態填入檢驗資訊 -->
        </div>

        <form onsubmit="event.preventDefault(); submitRemark();">
            <div class="mb-3">
                <label for="remarkInput" class="form-label fw-semibold" style="color: #333;">備註內容</label>
                <textarea rows="3" id="remarkInput" maxlength="190" class="form-control" placeholder="請輸入備註..."></textarea>
            </div>

            <div class="text-end">
                <button type="button" onclick="closeRemarkModal()" class="btn btn-secondary me-2">取消</button>
                <button type="submit" class="btn btn-primary" style="background: #0071b2;">確定提交</button>
            </div>
        </form>

        <input type="hidden" id="remarkRecordId" value="">
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        let inspectionData = null;
        let nfcReader = null;
        let isNFCSupported = false;
        let timePeriodsData = [];
        let inspectType = []
        let pendingNFCId = ""
        // 儲存入庫工單資料的全域變數
        let warehouseOrderData = [];
        
        const userNo = '@ViewBag.UserNo';

        $(document).ready(function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            const toastElement = document.getElementById('nfcToast');
            nfcToast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });

            initializeNFC();
            loadInspectTypeList()
            loadTodayInspection();
        });


        function updateCurrentTime() {
            const now = new Date();
            $('#currentTime').text(now.toLocaleString('zh-TW').replace(/\//g, '-'));
        }

        function showNFCStatus(message, type) {
            const toastElement = document.getElementById('nfcToast');
            const toastBody = toastElement.querySelector('.toast-body');
            
            toastElement.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-warning', 'text-bg-info');
            
            const colorMap = {
                'success': 'text-bg-success',
                'error': 'text-bg-danger',
                'warning': 'text-bg-warning',
                'info': 'text-bg-info'
            };
            
            toastElement.classList.add(colorMap[type] || 'text-bg-info');
            toastBody.textContent = message;
            
            nfcToast.show();
        }

        function loadInspectTypeList() {
            $.ajax({
                url: '@Url.Action("GetInspectTypeList", "Inspection")',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    showLoading(false);
                    if (response.success) {
                        inspectType = response.data
                    } else {
                        showError(response.message || '載入失敗');
                    }
                },
                error: function (xhr, status, error) {
                    showLoading(false);
                    let errorMessage = '載入失敗';
                    if (xhr.status === 401) {
                        errorMessage = '登入已過期，請重新登入';
                        setTimeout(() => window.location.href = '@Url.Action("Login", "Account")', 2000);
                    }
                    showError(errorMessage);
                }
            });
        }

        function loadTodayInspection() {
            showLoading(true);
            hideError();

            $.ajax({
                url: '@Url.Action("GetTodayInspection", "Inspection")',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    showLoading(false);
                    if (response.success) {
                        console.log("response",response)
                        displayTimePeriodsData(response.data);
                    } else {
                        showError(response.message || '載入失敗');
                    }
                },
                error: function (xhr, status, error) {
                    showLoading(false);
                    let errorMessage = '載入失敗';
                    if (xhr.status === 401) {
                        errorMessage = '登入已過期，請重新登入';
                        setTimeout(() => window.location.href = '@Url.Action("Login", "Account")', 2000);
                    }
                    showError(errorMessage);
                }
            });
        }
         


        function displayTimePeriodsData(data) {
            if (data.timePeriods && data.timePeriods.length > 0) {
                renderTimePeriods(data.timePeriods);
                document.getElementById('timePeriodsSection').style.display = 'block';
            } else {
                document.getElementById('timePeriodsSection').style.display = 'none';
            }
        }

        function renderTimePeriods(periods) {
            const container = $('#timePeriods');
            container.empty();

            periods.forEach((period, index) => {
                const periodElement = createPeriodElement(period, index);
                container.append(periodElement);
            });
        }

        function createPeriodElement(period, index) {
                    const currentClass = period.isCurrent ? 'border-primary' : '';
                    const currentStyle = period.isCurrent ? 'border-width: 2px; background: #f8fff8;' : '';
                    const inactiveStyle = !period.isCurrent ? 'background: #f8f8f8; opacity: 0.7;' : '';
            
                    const statusBadge = period.isCurrent ? 'bg-success text-white' : 
                                       (period.isPast ? 'bg-secondary text-white' : '');
                    const statusText = period.isCurrent ? '進行中' :
                                      (period.isPast ? '已結束' : '');

                    const areasText = period.areas ? period.areas.join(', ') : '未設定區域';

                    const periodElement = $(`
                        <div class="border rounded mb-1 bg-white ${currentClass}" style="${currentStyle}${inactiveStyle}" data-period="${index}">
                            <div class="p-2 border-bottom d-flex justify-content-between align-items-center" 
                                 style="cursor: pointer;" 
                                 onclick="togglePeriod(${index})"
                                 onmouseover="this.style.background='#f0f0f0'" 
                                 onmouseout="this.style.background=''">
                                <div>
                                    <div class="fw-bold">${period.startTime} - ${period.endTime}</div>
                                    <div style="color: #666;">${areasText}</div>
                                </div>
                                <div>
                                    ${statusText ? `<span class="badge ${statusBadge} px-2 py-1 rounded me-2">${statusText}</span>` : ''}
                                    <span class="accordion-icon" style="transition: transform 0.3s ease;">▼</span>
                                </div>
                            </div>
                            <div class="period-content p-2 bg-white" id="period-content-${index}" style="display: none;">
                                ${createPeriodContentHtml(period)}
                            </div>
                        </div>
                    `);

                    // 如果是當前時段，自動展開
                    if (period.isCurrent) {
                        periodElement.find('.period-content').css('display', 'block');
                        periodElement.find('.accordion-icon').css('transform', 'rotate(180deg)');
                    }

                    return periodElement;
                }

                function createPeriodContentHtml(period) {
            let contentHtml = `
                <div class="border rounded p-2 mb-2" style="background: #f0f8ff;">
                    <strong>${period.eventType || '排程作業'}</strong>
                    ${period.eventDetail ? `<div>${period.eventDetail}</div>` : ''}
                </div>
            `;

            let rawDevicesToInspect = [...(period.devicesToInspect || [])];
            let extraTasks = (period.isCurrent && period.extraTask) ? period.extraTask : [];

            if (rawDevicesToInspect.length > 0 || extraTasks.length > 0) {
                const statusPriority = {
                    'RUN': 1,
                    'IDLE': 2,
                    'ALARM': 3,
                    'PMC資料缺漏': 4,
                    'OFF': 5
                };

                const devicesToInspect = rawDevicesToInspect.sort((a, b) => {
                    // ⭐ 優先排序：檢查是否有作業中的記錄
                    const aHasProgressing = a.inspectionList?.some(rec => rec.time.includes("作業中"));
                    const bHasProgressing = b.inspectionList?.some(rec => rec.time.includes("作業中"));

                    // 有作業中的排在前面
                    if (aHasProgressing && !bHasProgressing) return -1;
                    if (!aHasProgressing && bHasProgressing) return 1;

                    // 如果都有或都沒有作業中，則按原本的狀態排序
                    const statusA = a.deviceStatus?.status || 'PMC資料缺漏';
                    const statusB = b.deviceStatus?.status || 'PMC資料缺漏';
                    const priorityA = statusPriority[statusA] || 99;
                    const priorityB = statusPriority[statusB] || 99;

                    if (priorityA === priorityB) {
                        return a.deviceStatus.deviceID.localeCompare(b.deviceStatus.deviceID);
                    }
                    return priorityA - priorityB;
                });

                devicesToInspect.forEach(deviceToInspect => {
                    contentHtml += renderDeviceCard(deviceToInspect, period);
                });

            } else {
                contentHtml += '<div class="text-center p-4 text-muted">此時段無機台資料</div>';
            }

            return contentHtml;
        }

        function renderDeviceCard(deviceToInspect, period) {
            const device = deviceToInspect.deviceStatus;
            const status = device.status || 'PMC資料缺漏';
            const workOrderNo = device?.wO_ID ? device.wO_ID : "-";
            // console.log("deviceToInspect",deviceToInspect)
            // 狀態背景色
            let bgColor = '';
            if (status === "OFF" || period.isPast) bgColor = '#e4e4e4';
            if (status === "RUN") bgColor = '#d3ffd3';
            if (status === "IDLE") bgColor = '#fffbce';
            if (status === "ALARM") bgColor = '#eedadb';

            let borderLeftColor = '';
            let cardBg = '#fff';

            // 檢查警告狀態
            if (status === "RUN" && device.wO_ID) {
                if (!deviceToInspect.inspectionList || deviceToInspect.inspectionList.length === 0) {
                    bgColor = '#f7cbac';
                } else {
                    const lastRecord = deviceToInspect.inspectionList[0];
                    if (device.wO_ID.includes(lastRecord.inspectWo)) {
                        const now = new Date();
                        let endTimeStr = lastRecord.time.split('-').pop().trim();
           
                        if (!endTimeStr.includes('作業中')) {
                            const dateStr = now.toISOString().split('T')[0];
                            const fullDateTime = new Date(`${dateStr}T${endTimeStr}:00`);
                            const diffMs = now - fullDateTime;
                            const diffHours = diffMs / (1000 * 60 * 60);

                            if (diffHours > 2) {
                                bgColor = '#f7cbac';
                            }
                        }
                    } else {
                        bgColor = '#f7cbac';
                    }
                }
            }

            // 額外任務標示
            let extraBadge = deviceToInspect.isExtraTask
                ? `<span class="badge bg-secondary">其他執行項目</span>`
                : "";

            // 檢驗時間清單
            let inspectionsHtml = "";
    
            if (deviceToInspect.inspectionList && deviceToInspect.inspectionList.length > 0) {
                inspectionsHtml += `<ul class="list-unstyled mb-0">`;
                deviceToInspect.inspectionList.forEach(rec => {
                    const isProgressing = rec.time.includes("作業中");
                    if (isProgressing && rec.inspectorId === userNo) {
                        bgColor = '#cce5ff';
                    }

                    const safeRemark = (rec.remark || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                    inspectionsHtml += `
                        <li class="d-flex flex-wrap gap-1" style="cursor: pointer;"
                            onclick="handleInspectionClick('${rec.recordId}', '${rec.time}', '${rec.inspectWo}', '${rec.inspector}','${rec.inspectorId}','${rec.inspectType}', ${isProgressing}, '${device.deviceID}', '${safeRemark}')">
                            <span>${rec.time},</span>
                            <span>${rec.inspectWo}</span>
                            <span>(${rec.inspector})</span>
                            ${rec.isInProgress ? `<span class="badge bg-warning ms-1">進行中</span>` : ""}
                        </li>
                    `;
                });
                inspectionsHtml += `</ul>`;
            } else {
                inspectionsHtml = `<div class="text-muted small">無檢驗紀錄</div>`;
            }

            return `
                <div class="border rounded mb-2 p-2 bg-white" style="background-color: ${bgColor} !important;">
                    <div class="text-muted small">${extraBadge}</div>
                    ${!!device.deviceName ? 
                    `<div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="fw-bold">${device.deviceName}</div>
                        <div class="badge" style="background: ${bgColor}; color: #333; padding: 2px 6px; font-weight: bold;">${status}</div>
                    </div>
                    <!--<div class="text-muted mb-1">
                        ${device.deviceID || '-'}
                        </div>--!>` :
                    `<div class="fw-bold">
                    ${deviceToInspect.inspectionList[0].inspectType}
                    </div>` 
                    }
                    ${["機邊檢驗", "製一巡檢"].includes(deviceToInspect?.inspectionList?.[0]?.inspectType) ?
                        `<div class="mb-1" style="word-break: break-word; white-space: normal; color:black">
                            工單: ${workOrderNo}
                        </div>`
                        : ''
                    }
                    <div class="mt-2">
                        <strong class="small">檢驗紀錄</strong>
                        ${inspectionsHtml}
                    </div>
                </div>
            `;
        }

        // function handleInspectionClick(recordId, time, inspectWo, inspector, InspectorId, inspectType, isInProgress, deviceId) {
        //     if (inspectType === '入庫檢驗' || inspectType.includes('入庫') || inspectType.includes('全檢') || inspectType.includes('基恩斯') || inspectType.includes('三次元')) {
        //         showWarehouseOrderModal(recordId, time, inspectWo, inspector, InspectorId, inspectType, deviceId);
        //     } else {
        //         showQuantityInputModal(recordId, time, inspectWo, inspector, InspectorId, inspectType, deviceId);
        //     }
        // }
        function handleInspectionClick(recordId, time, inspectWo, inspector, InspectorId, inspectType, isInProgress, deviceId, remark) {

            if (!(time.includes("作業") || time.includes("檢驗"))) {
                showRemarkModal(recordId, time, inspectWo, inspector, InspectorId, inspectType, deviceId, remark);
            return;
        }
            // 簡單備註類型
            const simpleRemarkTypes = ['支援', '會議', '文書處理', '支援其他單位', '主管交派', '限樣'];

            if (simpleRemarkTypes.some(type => inspectType.includes(type))) {
                showRemarkModal(recordId, time, inspectWo, inspector, InspectorId, inspectType, deviceId);
            }
            // 入庫、全檢、基恩斯、三次元
            else if (inspectType === '入庫檢驗' || inspectType.includes('入庫') || inspectType.includes('全檢') || inspectType.includes('基恩斯') || inspectType.includes('三次元')) {
                showWarehouseOrderModal(recordId, time, inspectWo, inspector, InspectorId, inspectType, deviceId);
            }
            // 一般檢驗
            else {
                showQuantityInputModal(recordId, time, inspectWo, inspector, InspectorId, inspectType, deviceId);
            }
        }

      function showQuantityInputModal(recordId, time, inspectWo, inspector, InspectorId, inspectTypeA, deviceId) {
            if (InspectorId !== userNo) {
                return;
            }

            if (!(time.includes("作業") || time.includes("檢驗"))) {
                alert("如要填寫數量，請選擇作業中項目，提交後會將該筆作業中項目作為紀錄為檢驗結束");
                return;
            }

            document.getElementById('quantityRecordId').value = recordId;
            document.getElementById('quantityModalTitle').textContent = `輸入檢驗數量`;
            document.getElementById('quantityModalInfo').innerHTML = `
                <div><strong>檢驗類型:</strong> ${inspectTypeA}</div>
                <div><strong>檢驗時間:</strong> ${time}</div>
                <div><strong>工單號碼:</strong> ${inspectWo}</div>
                <div><strong>檢驗人員:</strong> ${inspector}</div>
                ${ inspectTypeA === "製一巡檢" ? "<div>當提交數量後，將會將此筆紀錄改為機邊檢驗</div>" : "" }
            `;

            document.getElementById('quantityWoInput').value = '';
            document.getElementById('okQuantity').value = '';
            document.getElementById('ngQuantity').value = '';
            document.getElementById('quantityRemark').value = '';

            document.getElementById('quantityInputModal').classList.remove('d-none');
            document.getElementById('quantityInputModal').classList.add('d-flex');
            document.getElementById('okQuantity').focus();
        }

        // 4. 關閉數量輸入Modal
        function closeQuantityInputModal() {
            document.getElementById('quantityInputModal').classList.add('d-none');
            document.getElementById('quantityInputModal').classList.remove('d-flex');
        }

        // 5. 提交檢驗數量
        function submitInspectionQuantity() {
            const quantityWo = document.getElementById('quantityWoInput').value;
            const recordId = document.getElementById('quantityRecordId').value;
            const okQuantity = parseInt(document.getElementById('okQuantity').value) || 0;
            const ngQuantity = parseInt(document.getElementById('ngQuantity').value) || 0;
            const remark = document.getElementById('quantityRemark').value;

            if (okQuantity < 0 || ngQuantity < 0) {
                alert('數量不能為負數');
                return;
            }

            const submitBtn = document.querySelector('#quantityInputModal .btn-primary');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '提交中...';
            submitBtn.disabled = true;

            $.ajax({
                url: '@Url.Action("UpdateInspectionQuantity", "Inspection")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    QuantityWo: quantityWo,
                    RecordId: recordId,
                    OkQuantity: okQuantity,
                    NgQuantity: ngQuantity,
                    Remark: remark
                }),
                success: function(response) {
                    if (response.success) {
                        alert('檢驗數量更新成功');
                        closeQuantityInputModal();
                        loadTodayInspection();
                    } else {
                        alert('更新失敗: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('系統錯誤，請稍後再試');
                    console.error('更新檢驗數量失敗:', error);
                },
                complete: function() {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
        }


        // 6. 點擊外部區域關閉Modal
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('quantityInputModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeQuantityInputModal();
                }
            });
        });

        function togglePeriod(index) {
            const content = $(`#period-content-${index}`);
            const icon = $(`.time-period[data-period="${index}"] .accordion-icon`);

            if (content.css('display') === 'none') {
                content.css('display', 'block');
                icon.css('transform', 'rotate(180deg)');
            } else {
                content.css('display', 'none');
                icon.css('transform', '');
            }
        }

        function showInspectionStartModal(deviceId, arriveTime, isExisting) {
            $('#modalDevice').text(deviceId);
            $('#modalTime').text(`時間: ${arriveTime}`);

            const modal = $('#inspectionModal');
            modal.show();
        }

        function closeInspectionModal() {
            $('#inspectionModal').hide();
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.remove('d-none');
            } else {
                loading.classList.add('d-none');
            }
        }

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorAlert.classList.remove('d-none');
        }

        function hideError() {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.classList.add('d-none');
        }
        
        // ================ 入庫相關 ==================

        function showWarehouseOrderModal(recordId, time, inspectWo, inspector, InspectorId, inspectType, deviceId) {
            if (InspectorId !== userNo) {
                return;
            }

            if (!(time.includes("作業") || time.includes("檢驗"))) {
                alert("如要填寫數量，請選擇作業中項目，提交後會將該筆作業中項目作為紀錄為檢驗結束");
                return;
            }

            document.getElementById('warehouseRecordId').value = recordId;
            document.getElementById('warehouseModalTitle').textContent = `入庫檢驗`;
            document.getElementById('warehouseModalInfo').innerHTML = `
                <div><strong>檢驗類型:</strong> ${inspectType}</div>
                <div><strong>檢驗時間:</strong> ${time}</div>
                <div><strong>檢驗人員:</strong> ${inspector}</div>
            `;

            loadWarehouseOrderData(recordId);

            document.getElementById('warehouseOrderModal').classList.remove('d-none');
            document.getElementById('warehouseOrderModal').classList.add('d-flex');
    
            setTimeout(() => {
                document.getElementById('newWorkOrder').focus();
            }, 100);
        }


       function closeWarehouseOrderModal() {
            document.getElementById('warehouseOrderModal').classList.add('d-none');
            document.getElementById('warehouseOrderModal').classList.remove('d-flex');
        }

        // 響應式處理（可選）
        function adjustModalForMobile() {
            const modal = document.getElementById('warehouseOrderModal');
            if (window.innerWidth <= 768) {
                const innerDiv = modal.querySelector('div > div');
                if (innerDiv) {
                    innerDiv.style.maxWidth = '95%';
                    innerDiv.style.margin = '10px';
                }
            }
        }

        // 當視窗大小改變時調整
        window.addEventListener('resize', adjustModalForMobile);


        function loadWarehouseOrderData(recordId) {
            const savedData = localStorage.getItem(`warehouse_${recordId}`);
            if (savedData) {
                warehouseOrderData = JSON.parse(savedData);
            } else {
                warehouseOrderData = [];
            }
            refreshWarehouseOrderList();
        }

    function saveWarehouseOrderData(recordId) {
        // 儲存到localStorage
        localStorage.setItem(`warehouse_${recordId}`, JSON.stringify(warehouseOrderData));
    }

        function addWarehouseOrder() {
            const workOrderInput = document.getElementById('newWorkOrder');
            const okQuantityInput = document.getElementById('newOkQuantity');
            const ngQuantityInput = document.getElementById('newNgQuantity');
            const warehouseRemarkInput = document.getElementById("warehouseRemark");

            const workOrder = workOrderInput.value.trim();
            const okQuantity = parseInt(okQuantityInput.value) || 0;
            const ngQuantity = parseInt(ngQuantityInput.value) || 0;
            const warehouseRemark = warehouseRemarkInput.value;

            if (!workOrder) {
                alert('請輸入工單號碼');
                workOrderInput.focus();
                return;
            }

            if (workOrder.length !== 10 && workOrder.length !== 12) {
                alert("工單應為12碼或沒有00開頭的10碼")
                return;
            }

            if (okQuantity < 0 || ngQuantity < 0) {
                alert('數量不能為負數');
                return;
            }
    
            if (okQuantity === 0 && ngQuantity === 0) {
                alert('OK數量和NG數量不能都為0');
                return;
            }
    
            const existingIndex = warehouseOrderData.findIndex(item => item.workOrder === workOrder);
            if (existingIndex >= 0) {
                warehouseOrderData[existingIndex] = {WorkOrder: workOrder, OkQuantity: okQuantity, NgQuantity: ngQuantity, Remark: warehouseRemark };
            } else {
                warehouseOrderData.push({WorkOrder: workOrder, OkQuantity: okQuantity, NgQuantity: ngQuantity, Remark: warehouseRemark });
            }
    
            workOrderInput.value = '';
            okQuantityInput.value = '';
            ngQuantityInput.value = '';
            warehouseRemarkInput.value = '';
    
            refreshWarehouseOrderList();
    
            const recordId = document.getElementById('warehouseRecordId').value;
            saveWarehouseOrderData(recordId);
    
            workOrderInput.focus();
        }


        function removeWarehouseOrder(index) {
            if (confirm('確定要刪除這筆工單嗎？')) {
                warehouseOrderData.splice(index, 1);
                refreshWarehouseOrderList();
        
                const recordId = document.getElementById('warehouseRecordId').value;
                saveWarehouseOrderData(recordId);
            }
        }

      function refreshWarehouseOrderList() {
            const container = document.getElementById('warehouseOrderList');
    
            if (warehouseOrderData.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">尚未新增任何工單</div>';
                return;
            }
    
            const html = warehouseOrderData.map((item, index) => `
                <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                    <div>
                        <strong>${item.WorkOrder}</strong>
                        <span class="ms-3 text-muted">
                            OK: ${item.OkQuantity} , NG: ${item.NgQuantity}
                        </span>
                        <span class="ms-3 text-muted">
                            註記: ${item.Remark}
                        </span>
                    </div>
                    <button type="button" onclick="removeWarehouseOrder(${index})" class="btn btn-danger btn-sm">
                        刪除
                    </button>
                </div>
            `).join('');
    
            container.innerHTML = html;
        }

    function submitWarehouseOrders() {
            if (warehouseOrderData.length === 0) {
                alert('請至少新增一筆工單資料');
                return;
            }
    
            const recordId = document.getElementById('warehouseRecordId').value;

            const submitBtn = document.querySelector('#warehouseOrderModal .btn-primary');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '提交中...';
            submitBtn.disabled = true;
            // console.log({
            //         RecordId: parseInt(recordId),
            //         Orders: warehouseOrderData,
            //     })
            $.ajax({
                url: '@Url.Action("SubmitWarehouseInspection", "Inspection")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    RecordId: parseInt(recordId),
                    Orders: warehouseOrderData,
                }),
                success: function(response) {
                    if (response.success) {
                        alert('提交成功');
                
                        localStorage.removeItem(`warehouse_${recordId}`);
                        warehouseOrderData = [];
                
                        closeWarehouseOrderModal();
                        loadTodayInspection();
                    } else {
                        alert('提交失敗: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('系統錯誤，請稍後再試');
                    console.error('提交入庫檢驗失敗:', error);
                },
                complete: function() {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
        }

    // Enter鍵快速新增
    document.addEventListener('DOMContentLoaded', function() {
        // 為工單輸入框添加Enter鍵監聽
        const workOrderInput = document.getElementById('newWorkOrder');
        const okQuantityInput = document.getElementById('newOkQuantity');
        const ngQuantityInput = document.getElementById('newNgQuantity');
    
        [workOrderInput, okQuantityInput, ngQuantityInput].forEach(input => {
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addWarehouseOrder();
                    }
                });
            }
        });
    
        // 點擊外部區域關閉Modal
        document.getElementById('warehouseOrderModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeWarehouseOrderModal();
            }
        });
    });

        // =================== 掃描機台ID ========================
    function showMachineIdInputModal() {
        document.getElementById('machineIdInputModal').classList.remove('d-none');
        document.getElementById('machineIdInputModal').classList.add('d-flex');
        document.getElementById('machineIdInput').focus();
    }

    function closeMachineIdInputModal() {
        document.getElementById('machineIdInputModal').classList.add('d-none');
        document.getElementById('machineIdInputModal').classList.remove('d-flex');
        document.getElementById('machineIdInput').value = '';
    }

        function executeMachineId() {
            const machineId = document.getElementById('machineIdInput').value;
            handleNFCCard(machineId, "");
        }

        // =================== NFC 相關 ======================

        // 初始化NFC功能
          async function initializeNFC() {
            try {
                if ('NDEFReader' in window) {
                    nfcReader = new NDEFReader();
                    isNFCSupported = true;
                    showNFCStatus("NFC功能正常", "success");
                    await startNFCReading();
                } else {
                    showNFCStatus("瀏覽器不支援NFC", "warning");
                }
            } catch (error) {
                showNFCStatus("NFC初始化失敗", "error");
            }
        }

        // 賦予頁面監聽器並開始掃描NFC 
        async function startNFCReading() {
            if (!nfcReader) {
                showNFCStatus("NFC沒有啟動...", "info");
                return;
            }

            try {
                nfcReader.removeEventListener("reading", handleNFCReadingByScan);
                nfcReader.removeEventListener("readingerror", handleNFCError);

                await nfcReader.scan();
                console.log("NFC掃描已啟動");
                showNFCStatus("NFC掃描中...", "info");

                nfcReader.addEventListener("reading", handleNFCReadingByScan);
                nfcReader.addEventListener("readingerror", handleNFCError);

            } catch (error) {
                console.error('掃描啟動失敗:', error);
                showNFCStatus(`NFC掃描失敗: ${error.message}`, "error");

                if (error.name === 'NotAllowedError') {
                    alert('請允許網站使用NFC功能');
                }
            }
        }

        // 這個函數執行的話代表感應到NFC卡片
        function handleNFCReadingByScan(event) {
            let cardId = event.serialNumber;
            let message = event.message;
            if (cardId) {
                showNFCStatus(`讀取到卡片: ${cardId}`, "success");
                handleNFCCard(cardId, message);
            } else {
                console.error('無法獲取卡片ID');
                showNFCStatus("無法讀取卡片ID", "error");
            }
        }

        function handleNFCCard(nfcId, message) {

            if (nfcId === "") {
                showNFCStatus("讀取到的NFC卡片ID為空，請重新感應");
                return;
            }

            $.ajax({
                url: '@Url.Action("ProcessNFCInspection", "Inspection")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    nfcId: nfcId
                }),
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        if (response.needConfirmation) {
                            showReplaceConfirmationModal(response);
                        } else {
                            showInspectionStartModal(response.deviceId, response.arriveTime, response.isExisting);
                            loadTodayInspection();
                        }
                    } else {
                        showNFCStatus(response.message, "error");

                        if (response.errorCode === 'CARD_NOT_FOUND') {
                            alert("此感應卡不存在於資料庫");
                        } else if (response.errorCode === 'NOT_LOGGED_IN') {
                            alert("請先登入系統");
                            window.location.href = '@Url.Action("Login", "Account")';
                        }
                    }
                },
                error: function (xhr, status, error) {
                    showNFCStatus('系統錯誤', "error");
                }
            });
        }

        function showInspectTypeModal() {
            const modal = document.getElementById('inspectTypeModal');
            if (modal) {
                modal.classList.remove('d-none');
                modal.classList.add('d-flex');
        
                const container = document.getElementById("inspectTypeOptions");
                if (container) {
                    container.innerHTML = '<option value="">請選擇...</option>';

                    inspectType.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = item;
                        container.appendChild(option);
                    });
                }
            }
        }

        function handleNFCError(error) {
            console.error('NFC讀取錯誤:', error);
            showNFCStatus(`讀取錯誤: ${error.message}`, "error");
        }

        function closeInspectTypeModal() {
            const modal = document.getElementById('inspectTypeModal');
            if (modal) {
                modal.classList.add('d-none');
                modal.classList.remove('d-flex');
                const selectElement = document.getElementById('inspectTypeOptions');
                if (selectElement) {
                    selectElement.value = '';
                }
            }
        }

        function handleInspectTypeChange() {
            const selectedType = document.getElementById("inspectTypeOptions").value;
        }

        function confirmInspectType() {
            const selectInspectType = document.getElementById("inspectTypeOptions").value;
            if (!selectInspectType) {
                alert('請選擇檢驗項目');
                return;
            }

            let shortTerm = ["文書處裡","基恩斯量測","手持式三次元量測","全檢(EUV區)","全檢(CNC區)","全檢(成型區)","全檢(三樓緩衝)",'全檢(二樓倉庫)','限樣(限樣室)','限樣(一樓放置區)','全檢','限樣'];
            if (shortTerm.includes(selectInspectType)) {
                if (pendingNFCId === "") {
                    pendingNFCId = selectInspectType;
                }
            }

            let workOrderNo = "";
            closeInspectTypeModal();

            $.ajax({
                url: '@Url.Action("ProcessNFCInspection", "Inspection")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    nfcId: pendingNFCId,
                    source: 'NFC',
                    inspectType: selectInspectType,
                    workOrderNo: workOrderNo
                }),
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        if (response.needConfirmation) {
                            showReplaceConfirmationModal(response);
                        } else {
                            showInspectionStartModal(response.deviceId, response.arriveTime, response.isExisting);
                            loadTodayInspection();
                        }
                    } else {
                        showNFCStatus(response.message, "error");

                        if (response.errorCode === 'CARD_NOT_FOUND') {
                            alert("此感應卡不存在於資料庫");
                        } else if (response.errorCode === 'NOT_LOGGED_IN') {
                            alert("請先登入系統");
                            window.location.href = '@Url.Action("Login", "Account")';
                        }
                    }
                },
                error: function (xhr, status, error) {
                    showNFCStatus('系統錯誤', "error");
                }
            });
        }

        function showReplaceConfirmationModal(response) {
            const confirmed = confirm(
                `${response.message}\n` +
                `確定要開始在新地點開始新的檢驗嗎？`
            );
            console.log("showReplaceConfirmationModal",response)
            if (confirmed) {
                $.ajax({
                    url: '@Url.Action("ProcessNFCInspection", "Inspection")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        nfcId: response.nfcId,
                        confirmReplace: true,
                        source: ["會議", "支援", "文書處理"].includes(response.nfcId) ? "Manual" : "NFC",
                        oldRecordId: response.pendingRecordId
                    }),
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            closeMachineIdInputModal();
                            showInspectionStartModal(response.deviceId, response.arriveTime, response.isExisting);
                            loadTodayInspection();
                        } else {
                            showNFCStatus(`替換失敗: ${response.message}`, "error");
                        }
                    },
                    error: function (xhr, status, error) {
                        showNFCStatus('替換失敗: 系統錯誤', "error");
                    }
                });
            } else {
                showNFCStatus('已取消新的巡檢記錄', 'info');
            }
        }

        function manualStartNFC() {
            if (isNFCSupported && nfcReader) {
                startNFCReading();
            } else {
                alert('NFC功能不可用');
            }
        }

        function stopNFC() {
            showNFCStatus("掃描已停止", "info");
        }

        function showInspectionStartModal(deviceId, arriveTime, isExisting) {
            $('#modalDevice').text(deviceId);
            $('#modalTime').text(`時間: ${arriveTime}`);

            const modal = document.getElementById('inspectionModal');
            modal.classList.remove('d-none');
            modal.classList.add('d-flex');
        }

        function closeInspectionModal(e) {
            if (e && e.target !== e.currentTarget) return;
            const modal = document.getElementById('inspectionModal');
            modal.classList.add('d-none');
            modal.classList.remove('d-flex');
        }

        ///////////////////////////////////////////////// 處理沒有卡片的事項
        function handleAction(value){

           const confirmed = confirm(`確定開始執行 ${value} 嗎?`)
           if (confirmed) {

           $.ajax({
                url: '@Url.Action("ProcessNFCInspection", "Inspection")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    nfcId: value,
                    source: 'Manual',
                    inspectType: value,
                    workOrderNo: ""
                }),
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        if (response.needConfirmation) {
                                showReplaceConfirmationModal(response);
                        } else {
                            showInspectionStartModal(response.deviceId, response.arriveTime, response.isExisting);
                            loadTodayInspection();
                        }
                    } else {
                        showNFCStatus(response.message, "error");

                        if (response.errorCode === 'CARD_NOT_FOUND') {
                            alert("此感應卡不存在於資料庫");
                        } else if (response.errorCode === 'NOT_LOGGED_IN') {
                            alert("請先登入系統");
                            window.location.href = '@Url.Action("Login", "Account")';
                        }
                    }
                },
                error: function (xhr, status, error) {
                    showNFCStatus('系統錯誤', "error");
                }
            });
           }
        }

                // 顯示備註Modal
        function showRemarkModal(recordId, time, inspectWo, inspector, InspectorId, inspectType, deviceId, existingRemark) {
            console.log("recordId", recordId, "time", time, "inspector", inspector, "InspectorId", InspectorId, "inspectType", inspectType, "remark", existingRemark);

            if (InspectorId !== userNo) {
                return;
            }

            // 移除作業中檢查，允許已完成項目編輯備註
            // if (!(time.includes("作業") || time.includes("檢驗"))) {
            //     alert("如要填寫備註，請選擇作業中項目");
            //     return;
            // }

            document.getElementById('remarkRecordId').value = recordId;
            document.getElementById('remarkModalTitle').textContent = `${inspectType} - 備註`;
            document.getElementById('remarkModalInfo').innerHTML = `
                <div><strong>檢驗類型:</strong> ${inspectType}</div>
                <div><strong>檢驗時間:</strong> ${time}</div>
                <div><strong>檢驗人員:</strong> ${inspector}</div>
                ${existingRemark ? `<div><strong>目前備註:</strong> ${existingRemark}</div>` : ''}
            `;

            // 顯示現有備註
            document.getElementById('remarkInput').value = existingRemark || '';

            document.getElementById('remarkModal').classList.remove('d-none');
            document.getElementById('remarkModal').classList.add('d-flex');
            document.getElementById('remarkInput').focus();
        }

        // 關閉備註Modal
        function closeRemarkModal() {
            document.getElementById('remarkModal').classList.add('d-none');
            document.getElementById('remarkModal').classList.remove('d-flex');
        }

        // 提交備註
        function submitRemark() {
            const recordId = document.getElementById('remarkRecordId').value;
            const remark = document.getElementById('remarkInput').value.trim();

            if (!remark) {
                alert('請輸入備註內容');
                return;
            }

            const submitBtn = document.querySelector('#remarkModal .btn-primary');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '提交中...';
            submitBtn.disabled = true;

            $.ajax({
                url: '@Url.Action("UpdateInspectionQuantity", "Inspection")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    RecordId: recordId,
                    Remark: remark,
                    OnlyForRemark : true
                }),
                success: function(response) {
                    if (response.success) {
                        alert('備註更新成功');
                        closeRemarkModal();
                        loadTodayInspection();
                    } else {
                        alert('更新失敗: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('系統錯誤，請稍後再試');
                    console.error('更新備註失敗:', error);
                },
                complete: function() {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
        }

        // 點擊外部區域關閉Modal
        document.addEventListener('DOMContentLoaded', function() {
            const remarkModal = document.getElementById('remarkModal');
            if (remarkModal) {
                remarkModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeRemarkModal();
                    }
                });
            }
        });
    </script>
}