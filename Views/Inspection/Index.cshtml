@model PatrolInspect.Models.LoginViewModel

@{
    ViewData["Title"] = "巡檢系統";
    Layout = "_Layout";
}

@section css {
    <style>
        .header {
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            background: #f5f5f5;
            display: flex;
            justify-content:space-between
        }

        .current-time {
            font-size:12px;
            font-weight: bold;
            color: #666;
        }

        .section {
            border: 1px solid #ccc;
            margin-bottom: 10px;
            background: #fff;
        }

        .section-title {
            background: #e0e0e0;
            padding: 8px 10px;
            margin: 0;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            font-size:16px;
        }

        .section-content {
            padding: 10px;
        }

        .stats-grid {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .stat-box {
            flex:1;
            text-align: center;
            padding: 8px;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }

        .stat-number {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .stat-label {
            color: #666;
        }

        /* .control-buttons {
            margin-bottom: 10px;
        } */

            .control-buttons button {
                padding: 6px 10px;
                margin-right: 5px;
                margin-bottom: 5px;
                border: 1px solid #ccc;
                background: #f0f0f0;
                cursor: pointer;
            }

                .control-buttons button:hover {
                    background: #e0e0e0;
                }

        .nfc-status {
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ccc;
            display: none;
        }

        .nfc-success {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .nfc-error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .nfc-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
        }

        .nfc-info {
            background: #d1ecf1;
            border-color: #bee5eb;
        }

        .nfc-log {
            background: #f8f8f8;
            border: 1px solid #ccc;
            padding: 8px;
            height: 120px;
            overflow-y: auto;
            font-family: monospace;
        }

        .log-entry {
            margin-bottom: 2px;
            word-break: break-all;
        }

        /* 時段 Accordion 樣式 */
        .time-periods {
            margin-bottom: 10px;
        }

        .time-period {
            border: 1px solid #ddd;
            margin-bottom: 3px;
            background: #fff;
        }

            .time-period.inactive {
                background: #f8f8f8;
                opacity: 0.7;
            }

            .time-period.current {
                border: 2px solid #0071b2;
                background: #f8fff8;
            }

        .period-header {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;

        }

            .period-header:hover {
                background: #f0f0f0;
            }

        .period-time {
            font-weight: bold;
        }

        .period-areas {
            color: #666;
        }

        .period-status {
            padding: 2px 6px;
            border-radius: 3px;
        }

        .status-current {
            background: #28a745;
            color: white;
        }

        .status-upcoming {
            background: #ffc107;
            color: black;
        }

        .status-completed {
            background: #6c757d;
            color: white;
        }

        .accordion-icon {
            transition: transform 0.3s ease;
        }

            .accordion-icon.expanded {
                transform: rotate(180deg);
            }

        .period-content {
            display: none;
            padding: 10px;
            background: #fff;
        }

            .period-content.expanded {
                display: block;
            }

        .period-info {
            background: #f0f8ff;
            border: 1px solid #ccc;
            padding: 8px;
            margin-bottom: 10px;
        }

        .device-card {
            border: 1px solid #ddd;
            margin-bottom: 8px;
            padding: 8px;
            background: #fff;
        }

            .device-card.needs-inspection {
                border-left: 3px solid #dc3545;
                background: #ffeeee;
            }

            .device-card.completed {
                border-left: 3px solid #28a745;
                background: #eeffee;
            }

            .device-card.not-running {
                border-left: 3px solid #6c757d;
                background: #f5f5f5;
                color: #666;
            }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .device-id {
            font-weight: bold;
        }

        .device-status {
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .status-run {
            background: #28a745;
            color: white;
        }

        .status-idle {
            background: #ffc107;
            color: black;
        }

        .status-stop {
            background: #dc3545;
            color: white;
        }

        .status-unknown {
            background: #6c757d;
            color: white;
        }

        .device-name {
            color: #777;
            margin-bottom: 4px;
        }

        .device-info {
            color: #666;
            margin-bottom: 2px;
        }

        .inspection-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 3px;
            font-weight: bold;
            margin-top: 5px;
        }

        .needs-inspection-badge {
            background: #dc3545;
            color: white;
        }

        .completed-badge {
            background: #28a745;
            color: white;
        }

        .not-required-badge {
            background: #e9ecef;
            color: #6c757d;
        }

        .no-devices {
            text-align: center;
            padding: 20px;
            color: #666;

        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;

        }

        .error {
            color: red;
            padding: 10px;
            background: #ffe8e8;
            border: 1px solid red;
            display: none;
        }

        /* Modal 樣式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border: 2px solid #333;
            max-width: 300px;
            text-align: center;
            margin: 10px;
        }

            .modal-content h3 {
                margin-bottom: 10px;
                color: #333;

            }

            .modal-content p {
                margin-bottom: 8px;

            }

            .modal-content button {
                padding: 8px 15px;
                background: #333;
                color: white;
                border: none;
                cursor: pointer;
                margin-top: 10px;
            }
    </style>
}

<div class="container">
    <!-- 使用者資訊 -->
    <div class="header">
        <div class="">
            <strong>@ViewBag.UserName (@ViewBag.UserNo)</strong>
            <div style="color: #666;" id="simulateNfc">@ViewBag.DepartmentName - @ViewBag.TitleName</div>
            <div class="current-time" id="currentTime">@ViewBag.CurrentTime</div>
        </div>
        <div class="control-buttons">
            <button onclick="loadTodayInspection()">刷新資料</button>
            @* <button onclick="refreshDeviceStatus()">刷新狀態</button> *@
        </div>
    </div>

    <!-- 統計資訊 -->
    <div class="section">
        <h3 class="section-title">目前時段統計</h3>
        <div class="section-content">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-number" id="totalDevices">-</div>
                    <div class="stat-label">總機台</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="withWoDevices">-</div>
                    <div class="stat-label">有掛工單機台數</div>
                </div>
                @* <div class="stat-box">
                    <div class="stat-number" id="completedInspections">-</div>
                    <div class="stat-label">已巡檢</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="pendingInspections">-</div>
                    <div class="stat-label">待巡檢</div>
                </div> *@
            </div>


        </div>
    </div>

    <!-- 載入/錯誤狀態 -->
    <div id="loading" class="loading">載入中...</div>
    <div id="error" class="error"></div>

    <!-- 時段排程 Accordion -->
    <div id="timePeriodsSection" class="section" style="display: none;">
        <h3 class="section-title">今日排程</h3>
        <div class="section-content">
            <div id="timePeriods" class="time-periods"></div>
        </div>
    </div>

    <!-- NFC 感應 -->
    <div class="section">
        <h3 class="section-title">NFC 感應</h3>
        <div class="section-content">
            <div id="nfcStatus" class="nfc-status"></div>
            <div style="margin-bottom: 8px;" class="control-buttons">
                <button onclick="manualStartNFC()">啟動感應</button>
                <button onclick="stopNFC()">停止感應</button>
                @* <button onclick="clearNFCLog()">清除日誌</button> *@
            </div>
            <div id="nfcLog" class="nfc-log"></div> 
        </div>
    </div>

    <!-- 檢驗開始提示 -->
    <div id="inspectionModal" class="modal">
        <div class="modal-content">
            <h3>檢驗開始</h3>
            <p><strong id="modalDevice">-</strong></p>
            <p id="modalTime">-</p>
            <p>請在機邊電腦完成資料上傳</p>
            @* <p style="color: #666;">
                <span id="countdown">10</span> 秒後自動關閉
            </p> *@
            <button onclick="closeInspectionModal()">確定</button>
        </div>
    </div>
</div>

@section scripts {
    <script>
        let inspectionData = null;
        let nfcReader = null;
        let isNFCSupported = false;
        let timePeriodsData = [];

        $(document).ready(function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            initializeNFC();
            loadTodayInspection();
                    $(document).on('click', '#simulateNfc', function () {
          handleNFCCard('62:bc:50:1f', null);
        });
        });


        function updateCurrentTime() {
            const now = new Date();
            $('#currentTime').text(now.toLocaleString('zh-TW').replace(/\//g, '-'));
        }

        function addNFCLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logContainer = $('#nfcLog');
            const entry = $('<div class="log-entry"></div>').text(`[${timestamp}] ${message}`);
            logContainer.append(entry);
            logContainer.scrollTop(logContainer[0].scrollHeight);

            const entries = logContainer.find('.log-entry');
            if (entries.length > 20) {
                entries.first().remove();
            }
        }

        function clearNFCLog() {
            $('#nfcLog').empty();
            addNFCLog('日誌已清除');
        }

        function showNFCStatus(message, type) {
            const statusDiv = $('#nfcStatus');
            statusDiv.removeClass('nfc-success nfc-error nfc-warning nfc-info');
            statusDiv.addClass('nfc-' + type);
            statusDiv.text(message).show();

            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.hide();
                }, 3000);
            }
        }

        // NFC 相關函數 (簡化版)
        async function initializeNFC() {
            try {
                addNFCLog('初始化NFC功能');

                if ('NDEFReader' in window) {
                    nfcReader = new NDEFReader();
                    isNFCSupported = true;
                    addNFCLog("NFC支援已啟用");
                    showNFCStatus("NFC功能正常", "success");
                    await startNFCReading();
                } else {
                    addNFCLog("瀏覽器不支援NFC");
                    showNFCStatus("瀏覽器不支援NFC", "warning");
                }
            } catch (error) {
                addNFCLog(`NFC錯誤: ${error.message}`);
                showNFCStatus("NFC初始化失敗", "error");
            }
        }

        async function startNFCReading() {
            try {
                await nfcReader.scan();
                addNFCLog("NFC掃描啟動");
                showNFCStatus("NFC掃描中", "info");

                nfcReader.addEventListener("reading", ({ message, serialNumber }) => {
                    addNFCLog(`檢測到卡片: ${serialNumber}`);
                    handleNFCCard(serialNumber, message);
                });

                nfcReader.addEventListener("readingerror", (error) => {
                    addNFCLog(`讀取錯誤: ${error.message}`);
                    showNFCStatus("讀取錯誤", "error");
                });

            } catch (error) {
                addNFCLog(`掃描失敗: ${error.message}`);
                showNFCStatus("NFC掃描失敗", "error");
            }
        }

        function handleNFCCard(serialNumber, message) {
            const cardId = serialNumber;
            addNFCLog(`處理卡片: ${cardId}`);

            let deviceId = findDeviceByCardId(cardId);

            if (deviceId) {
                autoRecordInspection(cardId, deviceId);
            } else {
                addNFCLog(`無法識別卡片: ${cardId}`);
                showNFCStatus(`無法識別的卡片: ${cardId}`, "warning");
                alert("該卡片不屬於目前檢驗時段內任一區域")
            }
        }

        function findDeviceByCardId(cardId) {
            if (!timePeriodsData) return null;

            for (const period of timePeriodsData) {
                if (period.devicesToInspect) {
                    const matchingDevice = period.devicesToInspect.find(item =>
                        item.device.nfcCardId === cardId
                    );
                    if (matchingDevice) {
                        return matchingDevice.device.deviceId;
                    }
                }
            }
            return null;
        }

        function autoRecordInspection(cardId, deviceId) {
            addNFCLog(`記錄巡檢: ${deviceId}`);

            const requestData = {
                cardId: cardId,
                deviceId: deviceId,
                source: 'NFC',
                inspectType: "INJECT_INSPECT"
            };

            $.ajax({
                url: '@Url.Action("RecordInspection", "Inspection")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        addNFCLog(`巡檢記錄成功: ${deviceId} (ID: ${response.recordId})`);
                        showNFCStatus(`${deviceId} 記錄成功`, "success");
                        showInspectionStartModal(response.deviceId, response.arriveTime, response.isExisting);
                        loadTodayInspection();
                    } else if (response.needConfirmation) {
                        showReplaceConfirmationModal(cardId, response.pendingDeviceId, response.newDeviceId, response.pendingRecordId);
                    } else {
                        addNFCLog(`巡檢記錄失敗: ${response.message}`);
                        showNFCStatus(`記錄失敗: ${response.message}`, "error");
                    }
                },
                error: function (xhr, status, error) {
                    addNFCLog(`巡檢記錄錯誤: ${xhr.status} ${error}`);
                    showNFCStatus('記錄失敗: 系統錯誤', "error");
                }
            });
        }

        function showReplaceConfirmationModal(cardId, pendingDeviceId, newDeviceId, pendingRecordId) {
            const confirmed = confirm(
                `你在 ${pendingDeviceId} 機台還有未完成的巡檢記錄，\n` +
                `確定要在 ${newDeviceId} 機台開始新的巡檢嗎？`
            );

            if (confirmed) {
                confirmReplaceInspection(cardId, newDeviceId, pendingRecordId);
            } else {
                addNFCLog('使用者取消替換巡檢記錄');
                showNFCStatus('已取消新的巡檢記錄', 'info');
            }
        }

        function confirmReplaceInspection(cardId, newDeviceId, oldRecordId) {
            const requestData = {
                cardId: cardId,
                newDeviceId: newDeviceId,
                oldRecordId: oldRecordId,
                inspectType: "INJECT_INSPECT",
                source: 'NFC'
            };

            $.ajax({
                url: '@Url.Action("ConfirmReplaceInspection", "Inspection")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        addNFCLog(`替換巡檢記錄成功: ${newDeviceId}`);
                        showNFCStatus(`${newDeviceId} 記錄成功`, "success");
                        showInspectionStartModal(response.deviceId, response.arriveTime, false);
                        loadTodayInspection();
                    } else {
                        addNFCLog(`替換巡檢記錄失敗: ${response.message}`);
                        showNFCStatus(`替換失敗: ${response.message}`, "error");
                    }
                },
                error: function (xhr, status, error) {
                    addNFCLog(`替換巡檢記錄錯誤: ${xhr.status} ${error}`);
                    showNFCStatus('替換失敗: 系統錯誤', "error");
                }
            });
        }

        function manualStartNFC() {
            addNFCLog('手動啟動NFC');
            if (isNFCSupported && nfcReader) {
                startNFCReading();
            } else {
                alert('NFC功能不可用');
            }
        }

        function stopNFC() {
            addNFCLog('NFC掃描停止');
            showNFCStatus("掃描已停止", "info");
        }

        function loadTodayInspection() {
            showLoading(true);
            hideError();

            $.ajax({
                url: '@Url.Action("GetTodayInspection", "Inspection")',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    showLoading(false);
                    if (response.success) {
                        inspectionData = response.data;
                        displayTimePeriodsData(response.data);
                        addNFCLog("資料載入完成");
                    } else {
                        showError(response.message || '載入失敗');
                        addNFCLog("資料載入失敗");
                    }
                },
                error: function (xhr, status, error) {
                    showLoading(false);
                    let errorMessage = '載入失敗';
                    if (xhr.status === 401) {
                        errorMessage = '登入已過期，請重新登入';
                        setTimeout(() => window.location.href = '@Url.Action("Login", "Account")', 2000);
                    }
                    showError(errorMessage);
                    addNFCLog(`載入錯誤: ${xhr.status} ${error}`);
                }
            });
        }

        function refreshDeviceStatus() {
            addNFCLog("刷新機台狀態");

            $.ajax({
                url: '@Url.Action("RefreshDeviceStatus", "Inspection")',
                type: 'POST',
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        inspectionData = response.data;
                        displayTimePeriodsData(response.data);
                        addNFCLog("狀態刷新完成");
                        showNFCStatus("狀態已更新", "success");
                    } else {
                        showError(response.message || '刷新失敗');
                        addNFCLog("狀態刷新失敗");
                    }
                },
                error: function (xhr, status, error) {
                    showError('刷新失敗');
                    addNFCLog(`刷新錯誤: ${xhr.status} ${error}`);
                }
            });
        }

        function displayTimePeriodsData(data) {
            console.log("displayTimePeriodsData",data)
            // 更新整體統計
            $('#totalDevices').text(data.totalDevices || 0);
            $('#withWoDevices').text(data.withWoDevices || 0);
            $('#completedInspections').text(data.completedInspections || 0);
            $('#pendingInspections').text(
                data.devicesToInspect ? data.devicesToInspect.filter(d => d.requiresInspection).length : 0
            );

            // 處理時段資料
            if (data.timePeriods && data.timePeriods.length > 0) {
                timePeriodsData = data.timePeriods;
                renderTimePeriods(data.timePeriods);
                $('#timePeriodsSection').show();
            } else {
                $('#timePeriodsSection').hide();
                addNFCLog("無時段資料");
            }
        }

        function renderTimePeriods(periods) {
            const container = $('#timePeriods');
            container.empty();

            periods.forEach((period, index) => {
                console.log("****************開始建立大時段檢驗**********************")
                console.log("**************** ", period.startTime,"-",period.endTime," **********************")
                const periodElement = createPeriodElement(period, index);
                container.append(periodElement);
            });
        }

        function createPeriodElement(period, index) {
            const periodClass = period.isCurrent ? 'current' : 'inactive';  //curent有藍色邊框
            const statusClass = period.isCurrent ? 'status-current' :
                               (period.isPast ? 'status-completed' : 'status-upcoming');
            const statusText = period.isCurrent ? '進行中' :
                              (period.isPast ? '已結束' : '');

            const areasText = period.areas ? period.areas.join(', ') : '未設定區域';

            const periodElement = $(`
                <div class="time-period ${periodClass}" data-period="${index}">
                    <div class="period-header" onclick="togglePeriod(${index})">
                        <div>
                            <div class="period-time">${period.startTime} - ${period.endTime}</div>
                            <div class="period-areas">${areasText}</div>
                        </div>
                        <div>
                            <span class="period-status ${statusClass}">${statusText}</span>
                            <span class="accordion-icon">▼</span>
                        </div>
                    </div>
                    <div class="period-content" id="period-content-${index}">
                        ${createPeriodContentHtml(period)}
                    </div>
                </div>
            `);

            // 如果是當前時段，自動展開
            if (period.isCurrent) {
                periodElement.find('.period-content').addClass('expanded');
                periodElement.find('.accordion-icon').addClass('expanded');
            }

            return periodElement;
        }

        function createPeriodContentHtml(period) {
            console.log({period})
            let contentHtml = `
                <div class="period-info">
                     <strong>${period.eventTypeName || '排程作業'}</strong>
                    ${period.eventDetail ? `<div>${period.eventDetail}</div>` : ''}
                </div>
            `;

            if (period.devicesToInspect && period.devicesToInspect.length > 0) {
                period.devicesToInspect.forEach(item => {
                    const device = item.device;
                    const status = item.status?.deviceStatus || 'UNKNOWN';
                    const workOrderNo = status?.wO_ID ? status.wO_ID : "-";
                    const lastInspection = item.lastInspectionTime
                        ? new Date(item.lastInspectionTime).toLocaleString('zh-TW')
                        : '-';
                    let cardClass = '';
                    let badgeClass = '';
                    let badgeText = '';

                    let lastInspectionStartTime = item?.lastInspectionStartTime ?
                        item.lastInspectionStartTime.replace("T", " ").replace(/-/g, "/").substring(5, 16) : "-"
                    let lastInspectionEndTime = item?.lastInspectionEndTime ?
                        item.lastInspectionEndTime.replace("T", " ").replace(/-/g, "/").substring(5, 16) : "-"
                    console.log({item})

                    if(item.lastInspectionTime) {
                        cardClass = 'completed';
                        badgeClass = 'completed-badge';
                        badgeText = '已完成';
                    } 

                    const statusClass = `status-${status.toLowerCase()}`;
                    console.log({statusClass})
                    contentHtml += `
                        <div class="device-card ${cardClass}">
                            <div class="device-header">
                                <div class="device-id">${device.deviceId}</div>
                                <div class="device-status ${""}">${status}</div>
                            </div>
                            <div class="device-name">${device.deviceName || '-'}</div>
                            <div class="device-info">工單: ${workOrderNo}</div>
                            <div class="device-info">巡檢開始: ${lastInspectionStartTime}</div>
                            <div class="device-info">巡檢完成: ${lastInspectionEndTime}</div>
                            <div class="device-info">巡檢人員: ${item.lastInspectorName || '-'}</div>

                        </div>
                    `;
                });
            } else {
                contentHtml += '<div class="no-devices">此時段無機台資料</div>';
            }

            return contentHtml;
        }


        function togglePeriod(index) {
            const content = $(`#period-content-${index}`);
            const icon = $(`.time-period[data-period="${index}"] .accordion-icon`);

            if (content.hasClass('expanded')) {
                content.removeClass('expanded');
                icon.removeClass('expanded');
            } else {
                content.addClass('expanded');
                icon.addClass('expanded');
            }
        }

        function showInspectionStartModal(deviceId, arriveTime, isExisting) {
            $('#modalDevice').text(deviceId);
            $('#modalTime').text(`時間: ${arriveTime}`);

            const modal = $('#inspectionModal');
            modal.show();
        }

        function closeInspectionModal() {
            $('#inspectionModal').hide();
        }

        function showLoading(show) {
            $('#loading').toggle(show);
        }

        function showError(message) {
            $('#error').text(message).show();
        }

        function hideError() {
            $('#error').hide();
        }
    </script>
}