@model PatrolInspect.Models.LoginViewModel

@{
    ViewData["Title"] = "檢驗項目管理 - 巡檢系統";
    Layout = "_Layout";
}

@section css {
    <style>
        .form-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

            .filter-item label {
                margin-bottom: 5px;
                font-weight: 600;
                color: #333;
            }

            .filter-item input,
            .filter-item select {
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }

        .table-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }

            .table th,
            .table td {
                border: 1px solid #ddd;
                padding: 12px 8px;
                text-align: left;
            }

            .table th {
                background-color: #f8f9fa;
                font-weight: 600;
                color: #333;
                position: sticky;
                top: 0;
            }

            .table tbody tr:hover {
                background-color: #f5f5f5;
            }

        .status-active {
            color: #28a745;
            font-weight: bold;
        }

        .status-inactive {
            color: #dc3545;
            font-weight: bold;
            opacity: 0.6;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                color: #333;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                box-sizing: border-box;
            }

            .form-group small {
                color: #666;
                font-size: 12px;
            }

        .pagination {
            text-align: center;
            margin-top: 20px;
        }

            .pagination button {
                margin: 0 5px;
            }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @@media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
            }

            .filter-item {
                width: 100%;
            }

            .table-container {
                overflow-x: auto;
            }

            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
            }
        }
    </style>
}

<div class="form-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0; color: #333;">檢驗項目管理</h1>
        <button onclick="openAddModal()" class="btn btn-primary btn-action">
           新增檢驗項目
        </button>
    </div>

    <!-- 篩選條件 -->
    <div class="filter-row">
        <div class="filter-item">
            <label>部門</label>
            <select id="filterDepartment" onchange="loadData()">
                <option value="">全部</option>
                <option value="QA">QA</option>
                <option value="QC">QC</option>
                <option value="環安">環安</option>
                <option value="生產">生產</option>
            </select>
        </div>

        <div class="filter-item">
            <label>區域</label>
            <select id="filterArea" onchange="loadData()">
                <option value="">全部</option>
                <option value="all">全部</option>
                <option value="射出一區">射出一區</option>
                <option value="射出二區">射出二區</option>
                <option value="射出三區">射出三區</option>
                <option value="復興廠射出">復興廠射出</option>
                <option value="無塵室">無塵室</option>
            </select>
        </div>

        <div class="filter-item">
            <label>狀態</label>
            <select id="filterStatus" onchange="loadData()">
                <option value="">全部</option>
                <option value="true">啟用</option>
                <option value="false">停用</option>
            </select>
        </div>

        <div class="filter-item" style="flex: 1; min-width: 200px;">
            <label>搜尋</label>
            <input type="text" id="searchText" placeholder="搜尋檢驗項目名稱" onkeyup="handleSearch()">
        </div>

        <div class="filter-item">
            <label>&nbsp;</label>
            <button onclick="resetFilters()" class="btn btn-outline-secondary">重置</button>
        </div>
    </div>
</div>

<!-- 載入指示器 -->
<div id="loadingIndicator" class="loading" style="display: none;">
    <i class="fa-solid fa-spinner fa-spin"></i> 載入中...
</div>

<!-- 資料表格 -->
<div id="tableContainer" class="table-container">
    <table class="table" id="inspectionTable">
        <thead>
            <tr>
                <th style="width: 60px;">ID</th>
                <th style="width: 180px;">檢驗項目名稱</th>
                <th style="width: 80px;">部門</th>
                <th style="width: 80px;">區域</th>
                <th style="width: 120px;">站點</th>
                <th style="width: 80px;">資料類型</th>
                <th style="width: 150px;">選項內容</th>
                <th style="width: 60px;">狀態</th>
                <th style="width: 100px;">建立時間</th>
                <th style="width: 120px;">操作</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- 動態載入資料 -->
        </tbody>
    </table>
</div>

<!-- 無資料提示 -->
<div id="noDataMessage" class="no-data" style="display: none;">
    <i class="fa-solid fa-inbox"></i><br>
    沒有符合條件的檢驗項目
</div>

<!-- 分頁控制 -->
<div id="pagination" class="pagination" style="display: none;">
    <button id="prevBtn" onclick="changePage(-1)" class="btn btn-secondary">
        <i class="fa-solid fa-chevron-left"></i> 上一頁
    </button>
    <span id="pageInfo" style="margin: 0 20px; line-height: 36px;"></span>
    <button id="nextBtn" onclick="changePage(1)" class="btn btn-secondary">
        下一頁 <i class="fa-solid fa-chevron-right"></i>
    </button>
</div>

<!-- 新增/編輯 Modal -->
<div id="itemModal" class="modal">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="modalTitle" style="margin: 0;">新增檢驗項目</h2>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>

        <!-- Alert 訊息 -->
        <div id="modalAlert" class="alert" style="display: none;"></div>

        <form id="itemForm">
            <input type="hidden" id="itemId">

            <div class="form-group">
                <label>檢驗項目名稱 *</label>
                <input type="text" id="inspectName" required maxlength="100" placeholder="請輸入檢驗項目名稱">
            </div>

            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>部門 *</label>
                    <select id="department" required>
                        <option value="">請選擇部門</option>
                        <option value="QA">QA</option>
                        <option value="QC">QC</option>
                        <option value="環安">環安</option>
                        <option value="生產">生產</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1;">
                    <label>檢驗區域 *</label>
                    <select id="inspectArea" required>
                        <option value="">請選擇區域</option>
                        <option value="all">全部</option>
                        <option value="射出一區">射出一區</option>
                        <option value="射出二區">射出二區</option>
                        <option value="射出三區">射出三區</option>
                        <option value="復興廠射出">復興廠射出</option>
                        <option value="無塵室">無塵室</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>站點</label>
                <input type="text" id="station" maxlength="50" placeholder="選填，如：RSP-150組裝站">
            </div>

            <div class="form-group">
                <label>資料類型 *</label>
                <select id="dataType" required onchange="toggleSelectOptions()">
                    <option value="">請選擇類型</option>
                    <option value="TEXT">文字輸入</option>
                    <option value="NUMBER">數字輸入</option>
                    <option value="BOOLEAN">是/否選擇</option>
                    <option value="SELECT">下拉選單</option>
                    <option value="PHOTO">拍照上傳</option>
                </select>
            </div>

            <div id="selectOptionsGroup" class="form-group" style="display: none;">
                <label>選項內容 (用逗號分隔) *</label>
                <input type="text" id="selectOptions" maxlength="999" placeholder="例：OK,NG,N/A">
                <small>僅適用於下拉選單類型，請用逗號分隔各選項</small>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="isRequired" value="true">
                    <span>必填項目</span>
                </label>
            </div>

            <div id="updateReasonGroup" class="form-group " style="display: none;">
                <label>異動原因</label>
                <textarea id="updateReason" rows="3" maxlength="50" placeholder="請說明此次異動的原因" style="resize: vertical;"></textarea>
            </div>
        </form>

        <div style="text-align: right; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            <button onclick="closeModal()" class="btn btn-secondary" style="margin-right: 10px;">
                取消
            </button>
            <button onclick="saveItem()" class="btn btn-primary" id="saveBtn">
                儲存
            </button>
        </div>
    </div>
</div>

@section scripts {
    <script>

        let currentPage = 1;
        let currentData = { items: [], totalPages: 0, totalCount: 0 };
        let searchTimeout = null;

        // 頁面載入時初始化
        $(document).ready(function() {
            document.getElementById('filterStatus').value = 'true'
            loadData();
        });

        function loadData() {
            showLoading(true);

            const query = {
                Page: currentPage,
                PageSize: 50,
                Department: document.getElementById('filterDepartment').value || null,
                InspectArea: document.getElementById('filterArea').value || null,
                IsActive: document.getElementById('filterStatus').value === '' ? null :
                          document.getElementById('filterStatus').value === 'true',
                SearchText: document.getElementById('searchText').value.trim() || null
            };

            $.ajax({
                url: '@Url.Action("GetInspectionItems", "ItemManage")',
                type: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(query),
                success: function(response) {
                    console.log('Response:', response);

                    if (response.success) {
                        currentData = response.data;
                        renderTable();
                        renderPagination();
                    } else {
                        alert(response.message || '載入資料失敗');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', xhr.responseText);
                    alert('載入基礎資料時發生錯誤: ' + error);
                },
                complete: function() {
                    showLoading(false);
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const noDataMessage = document.getElementById('noDataMessage');

            if (!currentData || !currentData.items || currentData.items.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('tableContainer').style.display = 'none';
                noDataMessage.style.display = 'block';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            noDataMessage.style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
            document.getElementById('pagination').style.display = currentData.totalPages > 1 ? 'block' : 'none';

            tbody.innerHTML = currentData.items.map(item => `
                <tr class="${!item.isActive ? 'opacity-50' : ''}">
                    <td>${item.itemId}</td>
                    <td><strong>${escapeHtml(item.inspectName)}</strong></td>
                    <td>${escapeHtml(item.department)}</td>
                    <td>${escapeHtml(item.inspectArea)}</td>
                    <td>${escapeHtml(item.station || '無')}</td>
                    <td>${getDataTypeText(item.dataType)}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                        title="${escapeHtml(item.selectOptions || '')}">
                        ${escapeHtml(item.selectOptions || '無')}
                    </td>
                    <td class="${item.isActive ? 'text-success fw-bold' : 'text-danger fw-bold'}">
                        ${item.isActive ? '啟用' : '停用'}
                    </td>
                    <td>${formatDate(item.createDate)}</td>
                    <td style="white-space: nowrap;">
                        <button onclick="editItem(${item.itemId})" class="btn btn-outline-primary btn-sm me-1" title="編輯">
                            編輯
                        </button>
                        <button onclick="toggleStatus(${item.itemId}, ${!item.isActive})"
                                class="btn ${item.isActive ? 'btn-outline-warning' : 'btn-outline-success'} btn-sm"
                                title="${item.isActive ? '停用' : '啟用'}">
                            ${item.isActive ? '停用' : '啟用'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageInfo = document.getElementById('pageInfo');

            if (!currentData || currentData.totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'block';
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= currentData.totalPages;

            pageInfo.textContent = `第 ${currentPage} 頁，共 ${currentData.totalPages} 頁 (總計 ${currentData.totalCount} 筆)`;
        }

        // 換頁
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= currentData.totalPages) {
                currentPage = newPage;
                loadData();
            }
        }

        // 處理搜尋
        function handleSearch() {
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadData();
            }, 500);
        }

        // 重置篩選
        function resetFilters() {
            document.getElementById('filterDepartment').value = '';
            document.getElementById('filterArea').value = '';
            document.getElementById('filterStatus').value = 'true';
            document.getElementById('searchText').value = '';
            currentPage = 1;
            loadData();
        }

        // 顯示載入狀態
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('tableContainer').style.display = show ? 'none' : 'block';
        }

        // 開啟新增 Modal
        function openAddModal() {
            document.getElementById('modalTitle').textContent = '新增檢驗項目';
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('updateReasonGroup').style.display = 'none';
            document.getElementById('selectOptionsGroup').style.display = 'none';
            document.getElementById('modalAlert').style.display = 'none';
            document.getElementById('itemModal').style.display = 'block';
        }

        // 編輯項目
        async function editItem(id) {
            try {
                const response = await fetch(`@Url.Action("GetInspectionItem", "ItemManage")?id=${id}`, {
                    method: 'GET'
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const item = result.data;

                    document.getElementById('modalTitle').textContent = '編輯檢驗項目';
                    document.getElementById('itemId').value = item.itemId;
                    document.getElementById('inspectName').value = item.inspectName;
                    document.getElementById('department').value = item.department;
                    document.getElementById('inspectArea').value = item.inspectArea;
                    document.getElementById('station').value = item.station || '';
                    document.getElementById('dataType').value = item.dataType;
                    document.getElementById('selectOptions').value = item.selectOptions || '';
                    document.getElementById('isRequired').checked = item.isRequired;

                    document.getElementById('updateReasonGroup').style.display = 'block';
                    document.getElementById('modalAlert').style.display = 'none';
                    toggleSelectOptions();
                    document.getElementById('itemModal').style.display = 'block';
                } else {
                    alert(result.message || '載入資料失敗');
                }
            } catch (error) {
                console.error('編輯項目錯誤:', error);
                alert('載入資料失敗: ' + error.message);
            }
        }

        // 切換狀態
        async function toggleStatus(id, isActive) {
            const action = isActive ? '啟用' : '停用';
            const reason = prompt(`請輸入${action}原因:`);

            if (reason === null) return;

            try {
                const response = await fetch('@Url.Action("ToggleInspectionItemStatus", "ItemManage")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ItemId: id,
                        IsActive: isActive,
                        UpdateReason: reason.trim()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message || `${action}成功！`);
                    loadData();
                } else {
                    alert(result.message || `${action}失敗`);
                }
            } catch (error) {
                console.error('切換狀態錯誤:', error);
                alert(`${action}失敗: ` + error.message);
            }
        }

        // 切換選項欄位顯示
        function toggleSelectOptions() {
            const dataType = document.getElementById('dataType').value;
            const optionsGroup = document.getElementById('selectOptionsGroup');
            const selectOptions = document.getElementById('selectOptions');

            if (dataType === 'SELECT') {
                optionsGroup.style.display = 'block';
                selectOptions.required = true;
            } else {
                optionsGroup.style.display = 'none';
                selectOptions.required = false;
                selectOptions.value = '';
            }
        }

        // 關閉 Modal
        function closeModal() {
            document.getElementById('itemModal').style.display = 'none';
            document.getElementById('modalAlert').style.display = 'none';
        }

        // 儲存項目
        async function saveItem() {
            const form = document.getElementById('itemForm');

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            if (document.getElementById('dataType').value === 'SELECT') {
                const options = document.getElementById('selectOptions').value.trim();
                if (!options) {
                    alert('下拉選單類型必須填入選項內容');
                    document.getElementById('selectOptions').focus();
                    return;
                }
            }

            const itemId = document.getElementById('itemId').value;
            const isEdit = itemId !== '';

            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = '處理中...';

            try {
                const data = {
                    InspectName: document.getElementById('inspectName').value.trim(),
                    Department: document.getElementById('department').value,
                    InspectArea: document.getElementById('inspectArea').value,
                    Station: document.getElementById('station').value.trim() || null,
                    DataType: document.getElementById('dataType').value,
                    SelectOptions: document.getElementById('selectOptions').value.trim() || null,
                    IsRequired: document.getElementById('isRequired').checked
                };

                if (isEdit) {
                    data.ItemId = parseInt(itemId);
                    data.UpdateReason = document.getElementById('updateReason').value.trim() || null;
                }

                const url = isEdit
                    ? '@Url.Action("UpdateInspectionItem", "ItemManage")'
                    : '@Url.Action("CreateInspectionItem", "ItemManage")';

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message || (isEdit ? '更新成功！' : '新增成功！'));
                    closeModal();
                    currentPage = 1;
                    loadData();
                } else {
                    alert(result.message || (isEdit ? '更新失敗' : '新增失敗'));
                }
            } catch (error) {
                console.error('儲存項目錯誤:', error);
                alert((isEdit ? '更新' : '新增') + '失敗: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // 輔助函數
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getDataTypeText(dataType) {
            const types = {
                'TEXT': '文字',
                'NUMBER': '數字',
                'BOOLEAN': '是否',
                'SELECT': '選單',
                'PHOTO': '拍照'
            };
            return types[dataType] || dataType;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';

            return date.getFullYear() + '/' +
                   String(date.getMonth() + 1).padStart(2, '0') + '/' +
                   String(date.getDate()).padStart(2, '0');
        }

        // ESC 鍵關閉 Modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('itemModal');
                if (modal.style.display === 'block') {
                    closeModal();
                }
            }
        });
    </script>
}